name: Deploy to Production

on:
  push:
    branches:
      - main
  workflow_dispatch:  # 允许手动触发

jobs:
  deploy:
    name: Deploy to Server
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: ${{ secrets.SSH_PORT || 22 }}
          script_stop: true
          script: |
            set -e
            set -x  # 启用调试模式，显示执行的命令
            
            echo "=========================================="
            echo "开始部署 LuckyRed"
            echo "=========================================="
            
            # 硬编码的服务器配置
            PROJECT_DIR="/opt/luckyred"
            API_SERVICE_NAME="luckyred-api"
            BOT_SERVICE_NAME="luckyred-bot"
            API_VENV_DIR="/opt/luckyred/api/.venv"
            BOT_VENV_DIR="/opt/luckyred/bot/.venv"
            
            echo "📁 项目目录: $PROJECT_DIR"
            echo "🔧 API 服务名称: $API_SERVICE_NAME"
            echo "🤖 Bot 服务名称: $BOT_SERVICE_NAME"
            echo "🐍 API 虚拟环境: $API_VENV_DIR"
            echo "🐍 Bot 虚拟环境: $BOT_VENV_DIR"
            echo "👤 当前用户: $(whoami)"
            echo "📂 当前目录: $(pwd)"
            echo "🐍 Python3 路径: $(which python3 2>/dev/null || echo '未找到')"
            echo "🐍 Python3 版本: $(python3 --version 2>&1 || echo '无法获取版本')"
            
            # ==========================================
            # 步骤 1: 检查并创建项目目录
            # ==========================================
            echo ""
            echo "=========================================="
            echo "步骤 1: 检查项目目录"
            echo "=========================================="
            
            # 检查并创建项目目录（如果需要）
            if [ ! -d "$PROJECT_DIR" ]; then
              echo "⚠️  项目目录不存在，创建目录..."
              sudo mkdir -p "$PROJECT_DIR"
              sudo chown -R $(whoami):$(whoami) "$PROJECT_DIR" || {
                echo "⚠️  无法更改目录所有者，尝试使用 sudo..."
              }
            fi
            
            # 检查目录权限
            if [ ! -w "$PROJECT_DIR" ]; then
              echo "⚠️  目录不可写，尝试修复权限..."
              sudo chown -R $(whoami):$(whoami) "$PROJECT_DIR" || {
                echo "❌ 无法修复目录权限"
                exit 1
              }
            fi
            
            # 进入项目目录
            cd "$PROJECT_DIR" || {
              echo "❌ 错误: 无法进入项目目录: $PROJECT_DIR"
              exit 1
            }
            
            echo "✅ 已进入项目目录: $(pwd)"
            
            # 解决 Git 所有权问题
            echo "🔧 配置 Git 安全目录..."
            git config --global --add safe.directory "$PROJECT_DIR" || {
              echo "⚠️  Git safe.directory 配置失败，继续..."
            }
            
            # 修复文件权限：确保当前用户拥有目录权限
            echo "🔧 修复目录权限..."
            sudo chown -R $USER:$USER "$PROJECT_DIR" || {
              echo "❌ 无法修复目录权限"
              exit 1
            }
            echo "✅ 目录权限已修复"
            
            # 检查是否是 git 仓库
            if [ ! -d ".git" ]; then
              echo "⚠️  不是 git 仓库，初始化或克隆..."
              # 如果目录为空，克隆仓库
              if [ -z "$(ls -A)" ]; then
                echo "📥 目录为空，克隆仓库..."
                git clone https://github.com/victor2025PH/hb20251207.git . || {
                  echo "❌ Git 克隆失败"
                  exit 1
                }
              else
                echo "❌ 目录不为空且不是 git 仓库，无法继续"
                exit 1
              fi
            fi
            
            # 拉取最新代码
            echo "📥 拉取最新代码..."
            git fetch origin main || {
              echo "❌ Git fetch 失败"
              exit 1
            }
            git reset --hard origin/main || {
              echo "⚠️  Git reset 失败，尝试 git pull..."
              git pull origin main || {
                echo "❌ Git pull 失败"
                exit 1
              }
            }
            echo "✅ 代码更新成功"
            
            # ==========================================
            # 步骤 2: 检查并创建虚拟环境
            # ==========================================
            echo ""
            echo "=========================================="
            echo "步骤 2: 检查并创建虚拟环境"
            echo "=========================================="
            
            # 确保 api 和 bot 目录存在
            echo "📂 确保 api 和 bot 目录存在..."
            mkdir -p "$PROJECT_DIR/api"
            mkdir -p "$PROJECT_DIR/bot"
            sudo chown -R $USER:$USER "$PROJECT_DIR/api" || {
              echo "⚠️  无法修复 api 目录权限，继续..."
            }
            sudo chown -R $USER:$USER "$PROJECT_DIR/bot" || {
              echo "⚠️  无法修复 bot 目录权限，继续..."
            }
            
            # 确保安装了 python3-venv 模块
            echo "🔧 确保 python3-venv 模块可用..."
            # 直接尝试安装（如果已安装，apt-get 会快速返回成功）
            # 这样可以避免检查命令的退出码问题
            sudo apt-get update && sudo apt-get install -y python3-venv || {
              echo "⚠️  安装 python3-venv 失败，但继续尝试创建虚拟环境..."
            }
            echo "✅ python3-venv 模块检查完成"
            
            # 创建虚拟环境的函数
            create_venv_if_needed() {
              local VENV_DIR=$1
              local VENV_NAME=$2
              
              echo "🔍 检查 $VENV_NAME 虚拟环境..."
              
              # 【核心修复】
              # 1. 定义状态变量，默认 false
              local VENV_STATUS="missing"
              
              # 2. 单行检测文件。
              # 如果文件存在，变量设为 found；如果不存在，变量设为 missing。
              # 关键点：整个这一行命令的最终退出码永远是 0，Runner 不会报错。
              [ -f "$VENV_DIR/bin/activate" ] && VENV_STATUS="found" || VENV_STATUS="missing"
              
              # 3. 根据变量状态进行处理（这里只判断字符串，绝对安全）
              if [ "$VENV_STATUS" = "found" ]; then
                echo "✅ $VENV_NAME 虚拟环境已存在且完整"
              else
                echo "⚠️  $VENV_NAME 虚拟环境缺失，准备重新创建..."
                
                # 清理旧目录
                sudo rm -rf "$VENV_DIR"
                
                # 确保父目录
                mkdir -p "$(dirname "$VENV_DIR")"
                sudo chown -R $USER:$USER "$(dirname "$VENV_DIR")"
                
                # 创建环境
                if python3 -m venv "$VENV_DIR"; then
                  echo "✅ venv 命令执行成功"
                else
                  echo "❌ 创建失败"
                  exit 1
                fi
                
                # 修复权限
                sudo chown -R $USER:$USER "$VENV_DIR"
                
                # 二次确认（同样使用单行安全写法）
                [ -f "$VENV_DIR/bin/activate" ] && echo "✅ 验证通过" || { echo "❌ 验证失败"; exit 1; }
              fi
            }
            
            # 创建 API 虚拟环境
            create_venv_if_needed "$API_VENV_DIR" "API"
            
            # 创建 Bot 虚拟环境
            create_venv_if_needed "$BOT_VENV_DIR" "Bot"
            
            # ==========================================
            # 步骤 3: 激活虚拟环境
            # ==========================================
            echo ""
            echo "=========================================="
            echo "步骤 3: 激活虚拟环境"
            echo "=========================================="
            
            echo "🔌 准备激活 API 虚拟环境..."
            echo "📂 activate 脚本路径: $API_VENV_DIR/bin/activate"
            
            # 再次确认文件存在（防止在验证后文件被删除）
            test -f "$API_VENV_DIR/bin/activate" 2>/dev/null || {
              echo "❌ 错误: API activate 脚本不存在，无法激活"
              echo "💡 调试信息:"
              echo "  - 虚拟环境目录: $API_VENV_DIR"
              echo "  - 目录是否存在: $([ -d "$API_VENV_DIR" ] && echo '是' || echo '否')"
              echo "  - bin 目录是否存在: $([ -d "$API_VENV_DIR/bin" ] && echo '是' || echo '否')"
              echo "  - bin 目录内容:"
              ls -la "$API_VENV_DIR/bin" 2>/dev/null || echo "  无法列出 bin 目录内容"
              exit 1
            }
            
            echo "📊 脚本权限: $(ls -l "$API_VENV_DIR/bin/activate" 2>/dev/null | awk '{print $1, $9}' || echo '无法读取权限')"
            echo "📊 脚本内容前5行:"
            head -n 5 "$API_VENV_DIR/bin/activate" 2>/dev/null || {
              echo "⚠️  无法读取 activate 脚本内容，但文件存在，继续尝试激活..."
            }
            
            # 激活 API 虚拟环境
            echo "🔌 执行: source $API_VENV_DIR/bin/activate"
            source "$API_VENV_DIR/bin/activate" || {
              echo "❌ 激活 API 虚拟环境失败"
              echo "💡 调试信息:"
              echo "  - activate 脚本路径: $API_VENV_DIR/bin/activate"
              echo "  - 脚本是否存在: $([ -f "$API_VENV_DIR/bin/activate" ] && echo '是' || echo '否')"
              echo "  - 脚本权限: $(ls -l "$API_VENV_DIR/bin/activate" 2>/dev/null || echo '无法读取')"
              echo "  - 当前 shell: $SHELL"
              echo "  - 当前目录: $(pwd)"
              exit 1
            }
            
            echo "✅ API 虚拟环境已激活"
            echo "🐍 Python 版本: $(python --version)"
            echo "🐍 Python 路径: $(which python)"
            echo "📦 pip 版本: $(pip --version)"
            echo "📦 pip 路径: $(which pip)"
            
            # ==========================================
            # 步骤 4: 安装依赖
            # ==========================================
            echo ""
            echo "=========================================="
            echo "步骤 4: 安装 Python 依赖"
            echo "=========================================="
            
            echo "📦 升级 pip..."
            pip install --upgrade pip || {
              echo "⚠️  pip 升级失败，继续..."
            }
            
            echo "📦 安装 API Python 依赖..."
            if [ -f "$PROJECT_DIR/api/requirements.txt" ]; then
              echo "📄 使用 requirements 文件: $PROJECT_DIR/api/requirements.txt"
              pip install -r "$PROJECT_DIR/api/requirements.txt" || {
                echo "⚠️  依赖安装失败，尝试使用 --no-cache-dir..."
                pip install -r "$PROJECT_DIR/api/requirements.txt" --no-cache-dir || {
                  echo "❌ API 依赖安装失败"
                  exit 1
                }
              }
              echo "✅ API Python 依赖安装完成"
            elif [ -f "$PROJECT_DIR/requirements.txt" ]; then
              echo "📄 使用 requirements 文件: $PROJECT_DIR/requirements.txt"
              pip install -r "$PROJECT_DIR/requirements.txt" || {
                echo "⚠️  依赖安装失败，尝试使用 --no-cache-dir..."
                pip install -r "$PROJECT_DIR/requirements.txt" --no-cache-dir || {
                  echo "❌ API 依赖安装失败"
                  exit 1
                }
              }
              echo "✅ API Python 依赖安装完成"
            else
              echo "⚠️  未找到 API requirements.txt，跳过依赖安装"
            fi
            
            # 安装 Bot Python 依赖
            echo ""
            echo "📦 安装 Bot Python 依赖..."
            deactivate 2>/dev/null || true
            source "$BOT_VENV_DIR/bin/activate" || {
              echo "❌ 激活 Bot 虚拟环境失败"
              exit 1
            }
            
            if [ -f "$PROJECT_DIR/bot/requirements.txt" ]; then
              echo "📄 使用 requirements 文件: $PROJECT_DIR/bot/requirements.txt"
              pip install -r "$PROJECT_DIR/bot/requirements.txt" || {
                echo "⚠️  依赖安装失败，尝试使用 --no-cache-dir..."
                pip install -r "$PROJECT_DIR/bot/requirements.txt" --no-cache-dir || {
                  echo "❌ Bot 依赖安装失败"
                  exit 1
                }
              }
              echo "✅ Bot Python 依赖安装完成"
            elif [ -f "$PROJECT_DIR/requirements.txt" ]; then
              echo "📄 使用 requirements 文件: $PROJECT_DIR/requirements.txt"
              pip install -r "$PROJECT_DIR/requirements.txt" || {
                echo "⚠️  依赖安装失败，尝试使用 --no-cache-dir..."
                pip install -r "$PROJECT_DIR/requirements.txt" --no-cache-dir || {
                  echo "❌ Bot 依赖安装失败"
                  exit 1
                }
              }
              echo "✅ Bot Python 依赖安装完成"
            else
              echo "⚠️  未找到 Bot requirements.txt，跳过依赖安装"
            fi
            
            # ==========================================
            # 步骤 5: 构建前端
            # ==========================================
            echo ""
            echo "=========================================="
            echo "步骤 5: 构建前端"
            echo "=========================================="
            
            if [ -d "$PROJECT_DIR/frontend" ]; then
              cd "$PROJECT_DIR/frontend" || {
                echo "❌ 无法进入前端目录"
                exit 1
              }
              echo "📂 当前前端目录: $(pwd)"
              
              # 检查 node_modules 是否存在，如果不存在则安装
              test -d "node_modules" && {
                echo "📦 更新前端依赖..."
                npm install || npm install --legacy-peer-deps || {
                  echo "⚠️  前端依赖更新失败，继续构建..."
                }
              } || {
                echo "📦 安装前端依赖..."
                npm install || {
                  echo "⚠️  npm install 失败，尝试使用 --legacy-peer-deps..."
                  npm install --legacy-peer-deps || {
                    echo "❌ 前端依赖安装失败"
                    exit 1
                  }
                }
              }
              
              # 构建前端
              echo "🔨 执行前端构建..."
              npm run build || {
                echo "❌ 前端构建失败，查看错误..."
                exit 1
              }
              echo "✅ 前端构建完成"
              cd "$PROJECT_DIR" || {
                echo "⚠️  无法返回项目根目录"
              }
            else
              echo "⚠️  前端目录不存在，跳过前端构建"
            fi
            
            # ==========================================
            # 步骤 6: 重启服务 (Simple & Safe)
            # ==========================================
            echo ""
            echo "=========================================="
            echo "步骤 6: 重启服务"
            echo "=========================================="
            echo "🔄 尝试重启 API 服务..."
            
            # 直接尝试重启。如果成功则打印成功；如果失败（服务不存在），则打印警告但不要退出。
            # 注意：必须写在同一行，不要使用反斜杠换行，避免语法错误。
            sudo systemctl restart "${API_SERVICE_NAME}" && echo "✅ API 服务重启成功" || echo "⚠️ API 服务未运行或不存在，请手动检查 (代码已成功部署)"
            
            echo ""
            echo "🔄 尝试重启 Bot 服务..."
            sudo systemctl restart "${BOT_SERVICE_NAME}" && echo "✅ Bot 服务重启成功" || echo "⚠️ Bot 服务未运行或不存在，请手动检查 (代码已成功部署)"
            
            echo ""
            echo "=========================================="
            echo "🎉 部署全部完成！"
            echo "=========================================="
            echo ""
            echo "📊 服务状态："
            sudo systemctl status "${API_SERVICE_NAME}" --no-pager -l | head -5 || echo "⚠️ 无法获取 API 服务状态"
            echo ""
            sudo systemctl status "${BOT_SERVICE_NAME}" --no-pager -l | head -5 || echo "⚠️ 无法获取 Bot 服务状态"
