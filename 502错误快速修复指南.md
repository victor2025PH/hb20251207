# ğŸ”§ 502 Bad Gateway å¿«é€Ÿä¿®å¤æŒ‡å—

## ğŸ” é—®é¢˜åˆ†æ

**ç°è±¡**ï¼š
- æµè§ˆå™¨æ˜¾ç¤º 502 Bad Gateway
- WebSocket è¿æ¥å¤±è´¥
- API è¯·æ±‚è¿”å› 502 é”™è¯¯

**åŸå› **ï¼š
- API æœåŠ¡å¯èƒ½æœªå¯åŠ¨
- æˆ–è€…æœåŠ¡å¯åŠ¨å¤±è´¥ï¼ˆç¼ºå°‘ä¾èµ–ï¼‰

---

## âœ… å¿«é€Ÿä¿®å¤æ­¥éª¤

### æ­¥éª¤1ï¼šå®‰è£…ç¼ºå¤±çš„ä¾èµ–

```bash
cd /opt/luckyred/api
source .venv/bin/activate
pip install email-validator pydantic[email]
```

### æ­¥éª¤2ï¼šé‡å¯æ‰€æœ‰æœåŠ¡

```bash
# é‡å¯ API æœåŠ¡
sudo systemctl restart luckyred-api

# é‡å¯ Bot æœåŠ¡ï¼ˆå¦‚æœéœ€è¦ï¼‰
sudo systemctl restart luckyred-bot

# é‡æ–°åŠ è½½ Nginx
sudo systemctl reload nginx
```

### æ­¥éª¤3ï¼šç­‰å¾…å¹¶æ£€æŸ¥æœåŠ¡çŠ¶æ€

```bash
# ç­‰å¾… 5 ç§’è®©æœåŠ¡å®Œå…¨å¯åŠ¨
sleep 5

# æ£€æŸ¥ API æœåŠ¡çŠ¶æ€
sudo systemctl status luckyred-api

# æ£€æŸ¥ Nginx çŠ¶æ€
sudo systemctl status nginx
```

### æ­¥éª¤4ï¼šæµ‹è¯•å¥åº·æ£€æŸ¥

```bash
# æµ‹è¯•æœ¬åœ°å¥åº·æ£€æŸ¥
curl http://localhost:8080/health

# æµ‹è¯•é€šè¿‡ Nginx çš„å¥åº·æ£€æŸ¥
curl https://mini.usdt2026.cc/api/v1/health
```

---

## ğŸ” å¦‚æœæœåŠ¡ä»ç„¶å¤±è´¥

### æŸ¥çœ‹è¯¦ç»†é”™è¯¯æ—¥å¿—

```bash
# æŸ¥çœ‹ API æœåŠ¡æ—¥å¿—
sudo journalctl -u luckyred-api -n 100 --no-pager

# æŸ¥çœ‹ Nginx é”™è¯¯æ—¥å¿—
sudo tail -50 /var/log/nginx/error.log

# æŸ¥çœ‹æœ€è¿‘çš„é”™è¯¯
sudo journalctl -u luckyred-api | grep -i error | tail -20
```

### æ‰‹åŠ¨æµ‹è¯• API å¯åŠ¨

```bash
cd /opt/luckyred/api
source .venv/bin/activate

# æµ‹è¯•å¯¼å…¥
python3 -c "from api.main import app; print('âœ… å¯¼å…¥æˆåŠŸ')"

# å¦‚æœå¯¼å…¥æˆåŠŸï¼Œæ‰‹åŠ¨å¯åŠ¨æµ‹è¯•
uvicorn main:app --host 127.0.0.1 --port 8080
```

---

## ğŸ“‹ å®Œæ•´ä¿®å¤å‘½ä»¤ï¼ˆä¸€é”®æ‰§è¡Œï¼‰

```bash
#!/bin/bash
# å®Œæ•´ä¿®å¤è„šæœ¬

echo "ğŸ”§ å¼€å§‹ä¿®å¤ 502 é”™è¯¯..."

# 1. å®‰è£…ä¾èµ–
echo "ğŸ“¦ å®‰è£…ä¾èµ–..."
cd /opt/luckyred/api
source .venv/bin/activate
pip install -q email-validator pydantic[email]

# 2. é‡å¯æœåŠ¡
echo "ğŸ”„ é‡å¯æœåŠ¡..."
sudo systemctl restart luckyred-api
sudo systemctl reload nginx

# 3. ç­‰å¾…å¯åŠ¨
echo "â³ ç­‰å¾…æœåŠ¡å¯åŠ¨..."
sleep 5

# 4. æ£€æŸ¥çŠ¶æ€
echo "ğŸ“Š æ£€æŸ¥æœåŠ¡çŠ¶æ€..."
sudo systemctl status luckyred-api --no-pager | head -10

# 5. æµ‹è¯•å¥åº·æ£€æŸ¥
echo "ğŸ¥ æµ‹è¯•å¥åº·æ£€æŸ¥..."
if curl -s http://localhost:8080/health >/dev/null; then
    echo "âœ… API æœåŠ¡æ­£å¸¸"
    curl -s http://localhost:8080/health | python3 -m json.tool 2>/dev/null || curl -s http://localhost:8080/health
else
    echo "âŒ API æœåŠ¡å¼‚å¸¸ï¼ŒæŸ¥çœ‹æ—¥å¿—ï¼š"
    sudo journalctl -u luckyred-api -n 30 --no-pager
fi
```

---

## âœ… é¢„æœŸç»“æœ

ä¿®å¤æˆåŠŸååº”è¯¥çœ‹åˆ°ï¼š
- âœ… æœåŠ¡çŠ¶æ€ï¼š`active (running)`
- âœ… å¥åº·æ£€æŸ¥ï¼š`{"status": "healthy", ...}`
- âœ… æµè§ˆå™¨å¯ä»¥æ­£å¸¸è®¿é—®
- âœ… WebSocket è¿æ¥æˆåŠŸ

---

## ğŸš¨ å¦‚æœä»ç„¶å¤±è´¥

è¯·æä¾›ä»¥ä¸‹ä¿¡æ¯ï¼š
1. æœåŠ¡çŠ¶æ€ï¼š`sudo systemctl status luckyred-api`
2. é”™è¯¯æ—¥å¿—ï¼š`sudo journalctl -u luckyred-api -n 50`
3. Nginx é”™è¯¯ï¼š`sudo tail -20 /var/log/nginx/error.log`

