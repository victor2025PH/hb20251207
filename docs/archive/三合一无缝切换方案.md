# ä¸‰åˆä¸€æ— ç¼åˆ‡æ¢æ–¹æ¡ˆè®¾è®¡

## ğŸ¯ è®¾è®¡ç›®æ ‡

åˆ›å»ºä¸€ä¸ªç»Ÿä¸€çš„ç³»ç»Ÿï¼Œè®©ç”¨æˆ·å¯ä»¥åœ¨ä»¥ä¸‹ä¸‰ç§æ–¹å¼ä¹‹é—´æ— ç¼åˆ‡æ¢ï¼š
1. **åº•éƒ¨é”®ç›˜ï¼ˆReply Keyboardï¼‰** - ä¼ ç»Ÿ bot äº¤äº’
2. **å†…è”æŒ‰é’®ï¼ˆInline Keyboardï¼‰** - æ¶ˆæ¯ä¸­çš„æŒ‰é’®
3. **MiniApp** - Web åº”ç”¨

## ğŸ—ï¸ æ¶æ„è®¾è®¡

### æ ¸å¿ƒæ¦‚å¿µ

```
ç”¨æˆ·æ“ä½œ
    â†“
ç»Ÿä¸€è·¯ç”±å±‚ï¼ˆæ ¹æ®ç”¨æˆ·åå¥½é€‰æ‹©å¤„ç†æ–¹å¼ï¼‰
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ åº•éƒ¨é”®ç›˜æ¨¡å¼ â”‚ å†…è”æŒ‰é’®æ¨¡å¼ â”‚ MiniAppæ¨¡å¼ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
å…±äº«ä¸šåŠ¡é€»è¾‘å±‚
    â†“
å…±äº«æ•°æ®åº“
```

### ç”¨æˆ·åå¥½å­˜å‚¨

åœ¨ `User` æ¨¡å‹ä¸­æ·»åŠ åå¥½è®¾ç½®ï¼š

```python
class User(Base):
    # ... ç°æœ‰å­—æ®µ ...
    
    # äº¤äº’æ¨¡å¼åå¥½
    interaction_mode: str = "auto"  # "keyboard", "inline", "miniapp", "auto"
    
    # ä¸Šæ¬¡ä½¿ç”¨çš„æ¨¡å¼ï¼ˆç”¨äºæ™ºèƒ½åˆ‡æ¢ï¼‰
    last_interaction_mode: str = "keyboard"
    
    # æ˜¯å¦å¯ç”¨æ— ç¼åˆ‡æ¢
    seamless_switch_enabled: bool = True
```

### ä¸‰ç§æ¨¡å¼çš„å®ç°

#### æ¨¡å¼ 1: åº•éƒ¨é”®ç›˜æ¨¡å¼ï¼ˆKeyboard Modeï¼‰
- ä½¿ç”¨ `ReplyKeyboardButton`ï¼ˆæ™®é€šæ–‡æœ¬ï¼Œä¸ä½¿ç”¨ `web_app`ï¼‰
- ç‚¹å‡»æŒ‰é’®å‘é€æ–‡æœ¬æ¶ˆæ¯ç»™ bot
- Bot å¤„ç†å¹¶å›å¤æ¶ˆæ¯
- **ä¼˜ç‚¹**ï¼šä¼ ç»Ÿä½“éªŒï¼Œåœ¨ç¾¤ç»„ä¸­ä¹Ÿèƒ½å·¥ä½œ
- **ç¼ºç‚¹**ï¼šéœ€è¦å¤šæ­¥äº¤äº’

#### æ¨¡å¼ 2: å†…è”æŒ‰é’®æ¨¡å¼ï¼ˆInline Modeï¼‰
- ä½¿ç”¨ `InlineKeyboardButton`ï¼ˆä½¿ç”¨ `callback_data`ï¼Œä¸ä½¿ç”¨ `web_app`ï¼‰
- ç‚¹å‡»æŒ‰é’®å‘é€ callback ç»™ bot
- Bot å¤„ç†å¹¶æ›´æ–°æ¶ˆæ¯
- **ä¼˜ç‚¹**ï¼šäº¤äº’æµç•…ï¼Œä¸éœ€è¦å‘é€æ–°æ¶ˆæ¯
- **ç¼ºç‚¹**ï¼šéœ€è¦ç‚¹å‡»æ¶ˆæ¯ä¸­çš„æŒ‰é’®

#### æ¨¡å¼ 3: MiniApp æ¨¡å¼
- ä½¿ç”¨ `WebAppInfo` æŒ‰é’®ï¼ˆ`web_app` å‚æ•°ï¼‰
- ç‚¹å‡»æŒ‰é’®ç›´æ¥æ‰“å¼€ miniapp
- **ä¼˜ç‚¹**ï¼šæœ€æµç•…çš„ä½“éªŒï¼ŒåŠŸèƒ½æœ€ä¸°å¯Œ
- **ç¼ºç‚¹**ï¼šåªåœ¨ç§èŠä¸­å·¥ä½œï¼Œéœ€è¦ç½‘ç»œ

## ğŸ”„ æ— ç¼åˆ‡æ¢æœºåˆ¶

### åˆ‡æ¢æŒ‰é’®è®¾è®¡

åœ¨æ¯æ¡æ¶ˆæ¯ä¸­æ·»åŠ ä¸€ä¸ªåˆ‡æ¢æŒ‰é’®ï¼š

```
[å½“å‰æ¨¡å¼: é”®ç›˜] [åˆ‡æ¢æ¨¡å¼ ğŸ”„]
```

æˆ–è€…ä½¿ç”¨å›¾æ ‡ï¼š
```
âŒ¨ï¸ é”®ç›˜æ¨¡å¼ | ğŸ”˜ å†…è”æ¨¡å¼ | ğŸ“± MiniApp
```

### åˆ‡æ¢é€»è¾‘

```python
async def switch_interaction_mode(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """åˆ‡æ¢äº¤äº’æ¨¡å¼"""
    user_id = update.effective_user.id
    current_mode = get_user_mode(user_id)
    
    # å¾ªç¯åˆ‡æ¢ï¼škeyboard â†’ inline â†’ miniapp â†’ keyboard
    mode_cycle = ["keyboard", "inline", "miniapp"]
    current_index = mode_cycle.index(current_mode)
    next_mode = mode_cycle[(current_index + 1) % len(mode_cycle)]
    
    # æ›´æ–°ç”¨æˆ·åå¥½
    update_user_mode(user_id, next_mode)
    
    # æ ¹æ®æ–°æ¨¡å¼é‡æ–°å‘é€å½“å‰èœå•
    await refresh_current_menu(update, context, next_mode)
```

### æ™ºèƒ½åˆ‡æ¢ï¼ˆAuto Modeï¼‰

```python
def get_effective_mode(user: User, chat_type: str) -> str:
    """æ ¹æ®ä¸Šä¸‹æ–‡æ™ºèƒ½é€‰æ‹©æ¨¡å¼"""
    if user.interaction_mode == "auto":
        # å¦‚æœåœ¨ç¾¤ç»„ä¸­ï¼Œå¼ºåˆ¶ä½¿ç”¨ keyboard æˆ– inline
        if chat_type == "group":
            return "inline"  # ç¾¤ç»„ä¸­ inline æŒ‰é’®å·¥ä½œæœ€å¥½
        
        # å¦‚æœåœ¨ç§èŠä¸­ï¼Œæ ¹æ®ä¸Šæ¬¡ä½¿ç”¨çš„æ¨¡å¼
        return user.last_interaction_mode or "keyboard"
    
    # å¦‚æœç”¨æˆ·æ˜ç¡®é€‰æ‹©äº†æ¨¡å¼
    if user.interaction_mode == "miniapp" and chat_type == "group":
        # miniapp åœ¨ç¾¤ç»„ä¸­ä¸å·¥ä½œï¼Œå›é€€åˆ° inline
        return "inline"
    
    return user.interaction_mode
```

## ğŸ“‹ å®ç°æ–¹æ¡ˆ

### 1. ç»Ÿä¸€é”®ç›˜ç”Ÿæˆå™¨

```python
# bot/keyboards/unified.py

from telegram import ReplyKeyboardMarkup, InlineKeyboardMarkup, KeyboardButton, InlineKeyboardButton, WebAppInfo
from shared.config.settings import get_settings

settings = get_settings()

def get_unified_keyboard(mode: str, menu_type: str = "main", user_id: int = None):
    """ç»Ÿä¸€é”®ç›˜ç”Ÿæˆå™¨ï¼Œæ ¹æ®æ¨¡å¼è¿”å›ä¸åŒçš„é”®ç›˜"""
    
    # å®šä¹‰èœå•é¡¹
    menu_items = {
        "main": [
            ("ğŸ’° éŒ¢åŒ…", "/wallet", f"{settings.MINIAPP_URL}/wallet"),
            ("ğŸ§§ ç´…åŒ…", "/packets", f"{settings.MINIAPP_URL}/packets"),
            ("ğŸ“ˆ è³ºå–", "/earn", f"{settings.MINIAPP_URL}/earn"),
            ("ğŸ® éŠæˆ²", "/game", f"{settings.MINIAPP_URL}/game"),
            ("ğŸ‘¤ æˆ‘çš„", "/profile", f"{settings.MINIAPP_URL}/profile"),
        ],
        # ... å…¶ä»–èœå•
    }
    
    items = menu_items.get(menu_type, menu_items["main"])
    
    if mode == "keyboard":
        # åº•éƒ¨é”®ç›˜æ¨¡å¼ï¼šä½¿ç”¨æ™®é€šæ–‡æœ¬æŒ‰é’®
        keyboard = []
        for i in range(0, len(items), 2):
            row = [
                KeyboardButton(items[i][0])
            ]
            if i + 1 < len(items):
                row.append(KeyboardButton(items[i+1][0]))
            keyboard.append(row)
        
        # æ·»åŠ åˆ‡æ¢æŒ‰é’®
        keyboard.append([
            KeyboardButton("ğŸ”„ åˆ‡æ›æ¨¡å¼")
        ])
        
        return ReplyKeyboardMarkup(keyboard, resize_keyboard=True)
    
    elif mode == "inline":
        # å†…è”æŒ‰é’®æ¨¡å¼ï¼šä½¿ç”¨ callback_data
        keyboard = []
        for i in range(0, len(items), 2):
            row = [
                InlineKeyboardButton(items[i][0], callback_data=f"menu:{items[i][1].replace('/', '')}")
            ]
            if i + 1 < len(items):
                row.append(InlineKeyboardButton(items[i+1][0], callback_data=f"menu:{items[i+1][1].replace('/', '')}"))
            keyboard.append(row)
        
        # æ·»åŠ åˆ‡æ¢æŒ‰é’®
        keyboard.append([
            InlineKeyboardButton("ğŸ”„ åˆ‡æ›æ¨¡å¼", callback_data="switch_mode")
        ])
        
        return InlineKeyboardMarkup(keyboard)
    
    elif mode == "miniapp":
        # MiniApp æ¨¡å¼ï¼šä½¿ç”¨ web_app
        keyboard = []
        for i in range(0, len(items), 2):
            row = [
                KeyboardButton(items[i][0], web_app=WebAppInfo(url=items[i][2]))
            ]
            if i + 1 < len(items):
                row.append(KeyboardButton(items[i+1][0], web_app=WebAppInfo(url=items[i+1][2])))
            keyboard.append(row)
        
        # æ·»åŠ åˆ‡æ¢æŒ‰é’®ï¼ˆä½¿ç”¨å†…è”æŒ‰é’®ï¼Œå› ä¸º web_app æŒ‰é’®ä¸èƒ½åˆ‡æ¢æ¨¡å¼ï¼‰
        inline_keyboard = [
            [InlineKeyboardButton("ğŸ”„ åˆ‡æ›æ¨¡å¼", callback_data="switch_mode")]
        ]
        
        return {
            "reply": ReplyKeyboardMarkup(keyboard, resize_keyboard=True),
            "inline": InlineKeyboardMarkup(inline_keyboard)
        }
    
    return None
```

### 2. ç»Ÿä¸€å¤„ç†è·¯ç”±

```python
# bot/handlers/unified.py

async def handle_unified_interaction(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """ç»Ÿä¸€å¤„ç†æ‰€æœ‰äº¤äº’"""
    user_id = update.effective_user.id
    chat_type = update.effective_chat.type
    
    # è·å–ç”¨æˆ·åå¥½
    user = await get_user_from_update(update, context)
    effective_mode = get_effective_mode(user, chat_type)
    
    # æ ¹æ®æ¨¡å¼è·¯ç”±åˆ°ä¸åŒçš„å¤„ç†å‡½æ•°
    if effective_mode == "keyboard":
        await handle_keyboard_mode(update, context)
    elif effective_mode == "inline":
        await handle_inline_mode(update, context)
    elif effective_mode == "miniapp":
        await handle_miniapp_mode(update, context)
```

### 3. æ¨¡å¼åˆ‡æ¢å¤„ç†å™¨

```python
# bot/handlers/mode_switch.py

async def switch_mode_callback(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """å¤„ç†æ¨¡å¼åˆ‡æ¢"""
    query = update.callback_query
    await query.answer()
    
    user_id = update.effective_user.id
    user = await get_user_from_update(update, context)
    
    # è·å–å½“å‰æ¨¡å¼
    current_mode = get_effective_mode(user, update.effective_chat.type)
    
    # åˆ‡æ¢åˆ°ä¸‹ä¸€ä¸ªæ¨¡å¼
    mode_cycle = ["keyboard", "inline", "miniapp"]
    current_index = mode_cycle.index(current_mode)
    next_mode = mode_cycle[(current_index + 1) % len(mode_cycle)]
    
    # æ£€æŸ¥æ¨¡å¼æ˜¯å¦å¯ç”¨ï¼ˆä¾‹å¦‚ miniapp åœ¨ç¾¤ç»„ä¸­ä¸å¯ç”¨ï¼‰
    chat_type = update.effective_chat.type
    if next_mode == "miniapp" and chat_type == "group":
        next_mode = "inline"  # å›é€€åˆ° inline
    
    # æ›´æ–°ç”¨æˆ·åå¥½
    await update_user_mode(user_id, next_mode)
    
    # åˆ·æ–°å½“å‰èœå•
    await refresh_menu_with_mode(update, context, next_mode)
    
    # å‘é€ç¡®è®¤æ¶ˆæ¯
    mode_names = {
        "keyboard": "âŒ¨ï¸ åº•éƒ¨é”®ç›˜æ¨¡å¼",
        "inline": "ğŸ”˜ å†…è”æŒ‰é’®æ¨¡å¼",
        "miniapp": "ğŸ“± MiniApp æ¨¡å¼"
    }
    
    await query.message.reply_text(
        f"âœ… å·²åˆ‡æ¢åˆ° {mode_names[next_mode]}\n\n"
        f"ç°åœ¨æ‚¨å¯ä»¥ä½¿ç”¨ {mode_names[next_mode]} è¿›è¡Œæ“ä½œã€‚",
        reply_markup=get_unified_keyboard(next_mode, "main", user_id)
    )
```

### 4. çŠ¶æ€åŒæ­¥æœºåˆ¶

```python
# bot/utils/state_sync.py

async def sync_state_to_miniapp(user_id: int, state: dict):
    """å°† bot çŠ¶æ€åŒæ­¥åˆ° miniapp"""
    # é€šè¿‡ API å°†çŠ¶æ€å‘é€åˆ° miniapp
    # ä¾‹å¦‚ï¼šç”¨æˆ·ä½™é¢ã€å½“å‰èœå•ç­‰
    pass

async def sync_state_from_miniapp(user_id: int, state: dict):
    """ä» miniapp åŒæ­¥çŠ¶æ€åˆ° bot"""
    # ä» miniapp æ¥æ”¶çŠ¶æ€æ›´æ–°
    # ä¾‹å¦‚ï¼šç”¨æˆ·æ“ä½œã€ä½™é¢å˜åŒ–ç­‰
    pass
```

## ğŸ¨ ç”¨æˆ·ä½“éªŒè®¾è®¡

### åˆå§‹è®¾ç½®

ç”¨æˆ·é¦–æ¬¡ä½¿ç”¨ `/start` æ—¶ï¼š

```
ğŸ§§ æ­¡è¿ä¾†åˆ° Lucky Redï¼

è«‹é¸æ“‡æ‚¨å–œæ­¡çš„äº¤äº’æ–¹å¼ï¼š

[âŒ¨ï¸ åº•éƒ¨é”®ç›˜] - ä¼ ç»Ÿ bot ä½“éªŒï¼Œåœ¨ç¾¤ç»„ä¸­ä¹Ÿèƒ½ä½¿ç”¨
[ğŸ”˜ å†…è”æŒ‰é’®] - æµç•…äº¤äº’ï¼Œç‚¹å‡»æ¶ˆæ¯ä¸­çš„æŒ‰é’®
[ğŸ“± MiniApp] - æœ€ä¸°å¯Œçš„åŠŸèƒ½ï¼Œæœ€ä½³ä½“éªŒ

ğŸ’¡ æ‚¨å¯ä»¥éšæ—¶ä½¿ç”¨ "ğŸ”„ åˆ‡æ›æ¨¡å¼" æŒ‰é’®åˆ‡æ¢
```

### æ¨¡å¼æŒ‡ç¤ºå™¨

åœ¨æ¯ä¸ªèœå•ä¸­æ˜¾ç¤ºå½“å‰æ¨¡å¼ï¼š

```
ğŸ’° æˆ‘çš„é’±åŒ…                    [å½“å‰: âŒ¨ï¸ é”®ç›˜æ¨¡å¼]

ä½™é¢ï¼š
â€¢ USDT: 100.0000
â€¢ TON: 50.0000

[ğŸ’° å……å€¼] [ğŸ’¸ æç¾]
[ğŸ“œ äº¤æ˜“è¨˜éŒ„] [ğŸ”„ å…Œæ›]
[ğŸ”„ åˆ‡æ›æ¨¡å¼]
```

### æ— ç¼åˆ‡æ¢åŠ¨ç”»

åˆ‡æ¢æ¨¡å¼æ—¶æ˜¾ç¤ºè¿‡æ¸¡æ¶ˆæ¯ï¼š

```
ğŸ”„ æ­£åœ¨åˆ‡æ¢æ¨¡å¼...
    â†“
âœ… å·²åˆ‡æ¢åˆ° ğŸ“± MiniApp æ¨¡å¼
    â†“
æ˜¾ç¤ºæ–°æ¨¡å¼çš„èœå•
```

## ğŸ“Š æ•°æ®åº“è¿ç§»

```python
# migrations/add_interaction_mode.py

def upgrade():
    op.add_column('users', 
        sa.Column('interaction_mode', sa.String(20), default='auto')
    )
    op.add_column('users',
        sa.Column('last_interaction_mode', sa.String(20), default='keyboard')
    )
    op.add_column('users',
        sa.Column('seamless_switch_enabled', sa.Boolean(), default=True)
    )
```

## ğŸ”§ å®ç°æ­¥éª¤

### é˜¶æ®µ 1: åŸºç¡€æ¶æ„
1. âœ… æ·»åŠ ç”¨æˆ·åå¥½å­—æ®µåˆ°æ•°æ®åº“
2. âœ… åˆ›å»ºç»Ÿä¸€é”®ç›˜ç”Ÿæˆå™¨
3. âœ… å®ç°æ¨¡å¼åˆ‡æ¢å¤„ç†å™¨

### é˜¶æ®µ 2: è·¯ç”±ç³»ç»Ÿ
1. âœ… åˆ›å»ºç»Ÿä¸€è·¯ç”±å±‚
2. âœ… å®ç°ä¸‰ç§æ¨¡å¼çš„å¤„ç†å‡½æ•°
3. âœ… æ·»åŠ æ™ºèƒ½æ¨¡å¼é€‰æ‹©

### é˜¶æ®µ 3: æ— ç¼åˆ‡æ¢
1. âœ… å®ç°çŠ¶æ€åŒæ­¥æœºåˆ¶
2. âœ… æ·»åŠ åˆ‡æ¢æŒ‰é’®åˆ°æ‰€æœ‰èœå•
3. âœ… å®ç°æ¨¡å¼åˆ‡æ¢åŠ¨ç”»

### é˜¶æ®µ 4: ä¼˜åŒ–ä½“éªŒ
1. âœ… æ·»åŠ æ¨¡å¼æŒ‡ç¤ºå™¨
2. âœ… ä¼˜åŒ–åˆ‡æ¢æµç¨‹
3. âœ… æ·»åŠ ä½¿ç”¨æç¤º

## ğŸ¯ ä¼˜åŠ¿

1. **çµæ´»æ€§**ï¼šç”¨æˆ·å¯ä»¥é€‰æ‹©æœ€é€‚åˆè‡ªå·±çš„æ–¹å¼
2. **å…¼å®¹æ€§**ï¼šåœ¨ç¾¤ç»„å’Œç§èŠä¸­éƒ½èƒ½å·¥ä½œ
3. **ä¸€è‡´æ€§**ï¼šä¸‰ç§æ–¹å¼å…±äº«ç›¸åŒçš„ä¸šåŠ¡é€»è¾‘å’Œæ•°æ®åº“
4. **å¯æ‰©å±•æ€§**ï¼šæœªæ¥å¯ä»¥è½»æ¾æ·»åŠ æ–°çš„äº¤äº’æ¨¡å¼
5. **ç”¨æˆ·ä½“éªŒ**ï¼šæ— ç¼åˆ‡æ¢ï¼Œä¸ä¼šä¸¢å¤±çŠ¶æ€

## ğŸ“ æ³¨æ„äº‹é¡¹

1. **çŠ¶æ€ç®¡ç†**ï¼šç¡®ä¿åˆ‡æ¢æ¨¡å¼æ—¶çŠ¶æ€ä¸ä¸¢å¤±
2. **æ€§èƒ½ä¼˜åŒ–**ï¼šé¿å…é¢‘ç¹åˆ‡æ¢å¯¼è‡´çš„æ€§èƒ½é—®é¢˜
3. **é”™è¯¯å¤„ç†**ï¼šå¤„ç†æ¨¡å¼ä¸å¯ç”¨çš„æƒ…å†µï¼ˆå¦‚ miniapp åœ¨ç¾¤ç»„ä¸­ï¼‰
4. **ç”¨æˆ·æ•™è‚²**ï¼šå¸®åŠ©ç”¨æˆ·ç†è§£ä¸åŒæ¨¡å¼çš„åŒºåˆ«
