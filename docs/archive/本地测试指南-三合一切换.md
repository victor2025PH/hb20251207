# 三合一无缝切换方案 - 本地测试指南

## 📋 测试前准备

### 1. 运行数据库迁移

```bash
# Windows
运行迁移.bat

# 或手动运行
cd c:\hbgm001
python migrations/add_interaction_mode.py
```

**预期输出**：
```
✅ 成功添加交互模式字段
```

### 2. 确认 Bot 已启动

```bash
# 检查 bot 是否运行
cd c:\hbgm001
启动机器人-详细.bat
```

**预期输出**：
```
🤖 Bot @your_bot_username started!
Bot 正在啟動，準備接收消息...
```

### 3. 检查环境配置

确认 `.env` 文件中的配置：
- `BOT_TOKEN` - Bot Token
- `MINIAPP_URL` - MiniApp URL（例如：`https://mini.usdt2026.cc`）
- `DATABASE_URL` - 数据库连接

## 🧪 测试内容清单

### 测试 1: 首次使用 - 模式选择

**目标**：验证新用户首次使用时能正确选择模式

**步骤**：
1. 使用新账号（或清空数据库中的用户记录）
2. 在 Telegram 中与 bot 私聊
3. 发送 `/start` 命令

**预期结果**：
- ✅ 显示欢迎消息
- ✅ 显示模式选择界面，包含四个选项：
  - ⌨️ 底部键盘
  - 🔘 内联按钮
  - 📱 MiniApp
  - 🔄 自动
- ✅ 每个选项都是可点击的按钮

**验证点**：
- [ ] 模式选择界面正确显示
- [ ] 所有按钮都可以点击
- [ ] 点击后显示确认消息

---

### 测试 2: 键盘模式（Keyboard Mode）

**目标**：验证键盘模式的完整功能

**步骤**：
1. 选择「⌨️ 底部键盘」模式
2. 观察底部键盘显示
3. 点击各个按钮测试

**预期结果**：
- ✅ 底部显示键盘按钮：
  - 💰 錢包
  - 🧧 紅包
  - 📈 賺取
  - 🎮 遊戲
  - 👤 我的
  - 🔄 切換模式
- ✅ 点击按钮后，bot 回复消息
- ✅ 点击「💰 錢包」后显示钱包菜单
- ✅ 点击「🔄 切換模式」可以切换模式

**验证点**：
- [ ] 底部键盘正确显示
- [ ] 所有按钮都能触发 bot 响应
- [ ] 菜单功能正常工作
- [ ] 切换模式功能正常

---

### 测试 3: 内联按钮模式（Inline Mode）

**目标**：验证内联按钮模式的完整功能

**步骤**：
1. 切换到「🔘 内联按钮」模式
2. 观察消息中的内联按钮
3. 点击各个按钮测试

**预期结果**：
- ✅ 消息中显示内联按钮（绿色按钮）
- ✅ 按钮包含：
  - 💰 錢包
  - 🧧 紅包
  - 📈 賺取
  - 🎮 遊戲
  - 👤 我的
  - 🔄 切換模式
- ✅ 点击按钮后，消息更新（不发送新消息）
- ✅ 点击「💰 錢包」后显示钱包菜单
- ✅ 点击「🔄 切換模式」可以切换模式

**验证点**：
- [ ] 内联按钮正确显示
- [ ] 所有按钮都能触发回调
- [ ] 消息更新流畅（不闪烁）
- [ ] 菜单功能正常工作
- [ ] 切换模式功能正常

---

### 测试 4: MiniApp 模式

**目标**：验证 MiniApp 模式的完整功能

**步骤**：
1. 切换到「📱 MiniApp」模式
2. 观察底部键盘和内联按钮
3. 点击各个按钮测试

**预期结果**：
- ✅ 底部显示键盘按钮（带 web_app）
- ✅ 消息中显示「🔄 切換模式」内联按钮
- ✅ 点击底部按钮直接打开 miniapp
- ✅ 点击「💰 錢包」打开钱包页面
- ✅ 点击「🧧 紅包」打开红包页面

**验证点**：
- [ ] 底部键盘正确显示（web_app 按钮）
- [ ] 点击按钮直接打开 miniapp
- [ ] miniapp 正确加载
- [ ] 切换模式功能正常（通过内联按钮）

**注意事项**：
- ⚠️ MiniApp 模式只在私聊中工作
- ⚠️ 如果在群组中，会自动回退到 inline 模式

---

### 测试 5: 自动模式（Auto Mode）

**目标**：验证自动模式的智能选择

**步骤**：
1. 选择「🔄 自动」模式
2. 在私聊中测试
3. 在群组中测试

**预期结果**：
- ✅ 在私聊中：使用上次的模式（默认 keyboard）
- ✅ 在群组中：自动使用 inline 模式
- ✅ 模式切换流畅

**验证点**：
- [ ] 私聊中正确选择模式
- [ ] 群组中正确回退到 inline
- [ ] 模式切换逻辑正确

---

### 测试 6: 模式切换功能

**目标**：验证三种模式之间的无缝切换

**步骤**：
1. 从键盘模式开始
2. 点击「🔄 切換模式」
3. 观察切换到内联模式
4. 再次点击切换
5. 观察切换到 MiniApp 模式
6. 再次点击切换
7. 观察切换回键盘模式

**预期结果**：
- ✅ 每次切换都显示确认消息
- ✅ 模式循环：keyboard → inline → miniapp → keyboard
- ✅ 切换后立即显示新模式的菜单
- ✅ 不丢失当前操作状态

**验证点**：
- [ ] 模式切换流畅
- [ ] 确认消息正确显示
- [ ] 菜单正确更新
- [ ] 状态不丢失

---

### 测试 7: 群组中的行为

**目标**：验证在群组中的正确行为

**步骤**：
1. 在群组中发送 `/start`
2. 尝试切换到 MiniApp 模式
3. 测试各种模式

**预期结果**：
- ✅ 在群组中，MiniApp 模式自动回退到 inline
- ✅ 键盘模式正常工作
- ✅ 内联模式正常工作
- ✅ 显示提示信息（如果在群组中选择 MiniApp）

**验证点**：
- [ ] 群组中模式选择正确
- [ ] MiniApp 自动回退
- [ ] 提示信息正确显示
- [ ] 其他模式正常工作

---

### 测试 8: 数据库持久化

**目标**：验证用户偏好正确保存

**步骤**：
1. 选择一种模式
2. 关闭 bot（或重启）
3. 重新发送 `/start`
4. 检查是否记住上次的模式

**预期结果**：
- ✅ 用户偏好正确保存到数据库
- ✅ 重启后记住上次的模式
- ✅ `interaction_mode` 字段正确更新
- ✅ `last_interaction_mode` 字段正确更新

**验证点**：
- [ ] 数据库字段正确更新
- [ ] 重启后模式保持
- [ ] 用户偏好持久化

---

### 测试 9: 错误处理

**目标**：验证错误情况的处理

**测试场景**：
1. 数据库连接失败
2. 用户不存在
3. 模式切换失败

**预期结果**：
- ✅ 显示友好的错误消息
- ✅ 不崩溃
- ✅ 日志记录错误

**验证点**：
- [ ] 错误处理正确
- [ ] 用户看到友好提示
- [ ] 日志正确记录

---

## 📊 测试检查表

### 功能测试

- [ ] 模式选择界面显示
- [ ] 键盘模式功能完整
- [ ] 内联模式功能完整
- [ ] MiniApp 模式功能完整
- [ ] 自动模式智能选择
- [ ] 模式切换流畅
- [ ] 群组中正确行为
- [ ] 数据库持久化
- [ ] 错误处理正确

### 用户体验测试

- [ ] 界面清晰易懂
- [ ] 切换流畅无卡顿
- [ ] 提示信息准确
- [ ] 错误提示友好
- [ ] 状态不丢失

### 兼容性测试

- [ ] 私聊中所有模式工作
- [ ] 群组中正确回退
- [ ] 不同 Telegram 客户端
- [ ] 不同操作系统

---

## 🔍 调试技巧

### 1. 查看日志

```bash
# 查看 bot 日志
# 在启动窗口中查看输出
```

**关键日志**：
- `[MODE_SWITCH]` - 模式切换相关
- `[KEYBOARD]` - 键盘处理相关
- `[CALLBACK]` - 回调处理相关

### 2. 检查数据库

```python
# 在 Python 中检查
from shared.database.connection import get_db
from shared.database.models import User

with get_db() as db:
    user = db.query(User).filter(User.tg_id == YOUR_USER_ID).first()
    print(f"Mode: {user.interaction_mode}")
    print(f"Last Mode: {user.last_interaction_mode}")
```

### 3. 测试特定功能

```python
# 测试模式切换
# 在 bot 中发送消息：/start
# 然后点击切换按钮
```

---

## 🐛 常见问题排查

### 问题 1: 模式选择界面不显示

**可能原因**：
- 数据库迁移未运行
- 用户已存在且已设置模式

**解决方法**：
1. 运行数据库迁移
2. 清空用户的 `interaction_mode` 字段
3. 重新发送 `/start`

### 问题 2: 模式切换不工作

**可能原因**：
- 处理器未注册
- 数据库字段未更新

**解决方法**：
1. 检查 `bot/main.py` 中是否注册了处理器
2. 检查数据库字段是否存在
3. 查看日志中的错误信息

### 问题 3: MiniApp 模式在群组中不工作

**这是正常行为**：
- MiniApp 模式在群组中不可用
- 系统会自动回退到 inline 模式

### 问题 4: 按钮没有响应

**可能原因**：
- 模式不正确
- 键盘生成器错误

**解决方法**：
1. 检查用户当前模式
2. 检查键盘生成器代码
3. 查看日志中的错误

---

## 📝 测试报告模板

```
测试日期：___________
测试人员：___________
Bot 版本：___________

测试结果：
- 模式选择：✅/❌
- 键盘模式：✅/❌
- 内联模式：✅/❌
- MiniApp 模式：✅/❌
- 自动模式：✅/❌
- 模式切换：✅/❌
- 群组行为：✅/❌
- 数据库持久化：✅/❌

发现的问题：
1. 
2. 
3. 

建议：
1. 
2. 
3. 
```

---

## ✅ 测试完成标准

所有测试项都通过：
- ✅ 三种模式都能正常工作
- ✅ 模式切换流畅无卡顿
- ✅ 在私聊和群组中都能正常工作
- ✅ 用户偏好正确保存
- ✅ 错误处理正确
- ✅ 用户体验良好

---

**开始测试吧！** 🚀
