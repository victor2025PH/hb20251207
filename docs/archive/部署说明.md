# 🚀 部署说明

## 📤 已推送到 GitHub

代码已成功推送到 GitHub，提交信息：
```
修复红包发送逻辑：机器人在群里使用callback_data，不在群里使用web_app按钮直接打开MiniApp
```

---

## 🔧 在 Cursor 外运行部署

### 方法 1：使用 PowerShell（推荐）

1. **打开新的 PowerShell 窗口**（不是 Cursor 的终端）
2. **导航到项目目录**：
   ```powershell
   cd C:\hbgm001
   ```
3. **运行部署脚本**：
   ```powershell
   .\部署到服务器.ps1
   ```

### 方法 2：使用 CMD

1. **打开新的 CMD 窗口**（不是 Cursor 的终端）
2. **导航到项目目录**：
   ```cmd
   cd C:\hbgm001
   ```
3. **运行部署脚本**：
   ```cmd
   部署到服务器.bat
   ```

---

## 📋 部署步骤说明

部署脚本会自动执行以下步骤：

1. **更新代码** - 从 GitHub 拉取最新代码
2. **构建前端** - 重新构建前端（包含调试面板和转盘游戏修复）
3. **更新 Nginx** - 更新配置文件（移除 X-Frame-Options）
4. **重启 API** - 重启后端服务（应用红包发送逻辑修改）
5. **重启 Bot** - 重启机器人服务

---

## ✅ 修改内容

### 1. 红包发送逻辑
- ✅ 机器人在群里：使用 `callback_data` 按钮（直接抢红包）
- ✅ 机器人不在群里：使用 `web_app` 按钮（直接打开 MiniApp，不弹确认框）
- ✅ 移除 API 路由中的重复发送逻辑

### 2. 转盘游戏修复
- ✅ 修复 `canvas-confetti` 在 Telegram WebView 中的兼容性问题
- ✅ 使用动态导入避免崩溃

### 3. 调试面板
- ✅ 添加 Debug Panel 组件
- ✅ 在 URL 后加 `#debug=1` 启用

### 4. Nginx 配置
- ✅ 移除 `X-Frame-Options` 限制
- ✅ 使用 CSP `frame-ancestors` 允许 Telegram 嵌入

---

## 🔍 验证部署

部署完成后，检查：

1. **服务状态**：
   ```bash
   ssh ubuntu@165.154.254.99 "sudo systemctl status luckyred-api luckyred-bot"
   ```

2. **测试红包发送**：
   - 在群里发送红包，应该只出现一个红包消息
   - 机器人在群里：按钮直接抢红包
   - 机器人不在群里：按钮直接打开 MiniApp

3. **测试转盘游戏**：
   - 在 Telegram 中打开 MiniApp
   - 进入游戏 → 点击转盘游戏
   - 应该正常显示，不再白屏

---

## 📝 注意事项

- 确保 SSH 密钥已配置，无需密码登录
- 确保服务器有 Git 访问权限
- 如果部署失败，检查服务器日志：
  ```bash
  ssh ubuntu@165.154.254.99 "sudo journalctl -u luckyred-api -n 50"
  ```
