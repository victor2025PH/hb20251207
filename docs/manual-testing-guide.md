# 手动测试指南

## 🎯 测试目标

验证所有新功能在浏览器中正常工作。

---

## 📋 测试前准备

### 1. 访问后台管理面板

**URL**: https://admin.usdt2026.cc

**验证**:
- [ ] 页面正常加载
- [ ] 显示登录界面
- [ ] HTTPS 证书有效（浏览器显示锁图标）

### 2. 登录系统

**使用管理员账号登录**

**验证**:
- [ ] 登录成功
- [ ] 跳转到后台首页
- [ ] 可以看到所有菜单项

---

## 🧪 功能测试清单

### 测试 1: 红包退款功能

**测试步骤**:
1. 进入 **"红包管理"** 页面
2. 在红包列表中找到：
   - 一个**未领取**的红包（`claimed_count = 0`）
   - 或一个**已过期**的红包（`status = expired`）
3. 点击该红包行的 **"退款"** 按钮
4. 在确认对话框中点击 **"确定"**

**预期结果**:
- [ ] 显示"退款成功"提示消息
- [ ] 红包状态变为"已退款"（`status = refunded`）
- [ ] 发送者余额已增加（可通过"用户管理"页面查看该用户的余额）

**验证方法**:
1. 记录退款前的发送者余额
2. 执行退款操作
3. 刷新页面，检查红包状态
4. 查看发送者余额是否增加

**如果失败**:
- 检查浏览器控制台（F12）是否有错误
- 查看后端日志：`sudo journalctl -u hbgm001-backend -n 50`

---

### 测试 2: 交易管理余额分类

**测试步骤**:
1. 进入 **"交易管理"** 页面
2. 查看交易列表
3. 找到 USDT 类型的交易
4. 检查是否显示 **"余额分类"** 列

**预期结果**:
- [ ] 交易列表显示 **"余额分类"** 列
- [ ] USDT 交易显示：
  - **"真实余额"**（绿色标签）- 表示用户充值或提现的金额
  - **"奖励余额"**（橙色标签）- 表示游戏奖励、推荐佣金等
- [ ] 其他币种（TON、Stars、Points）显示 "-"

**验证方法**:
1. 查看交易列表的列标题
2. 检查 USDT 交易的余额分类显示
3. 验证标签颜色是否正确

**如果失败**:
- 检查前端代码是否正确渲染
- 查看浏览器控制台是否有错误

---

### 测试 3: 推荐系统配置

**测试步骤**:
1. 进入 **"邀请管理"** 页面
2. 找到 **"佣金配置"** 卡片（通常在页面顶部或侧边）
3. 修改配置：
   - **一级佣金率**: `5%` (输入 `0.05`)
   - **二级佣金率**: `2%` (输入 `0.02`)
   - **代理奖励阈值**: `100` (邀请人数)
4. 点击 **"保存配置"** 按钮
5. 等待保存成功提示
6. **刷新页面**（F5）
7. 验证配置是否仍然存在

**预期结果**:
- [ ] 显示"保存成功"提示消息
- [ ] 刷新页面后，配置值仍然显示为刚才设置的值
- [ ] 配置已保存到数据库

**验证方法**:
1. 记录保存前的配置值
2. 修改并保存
3. 刷新页面
4. 检查配置值是否保持不变

**如果失败**:
- 检查浏览器控制台是否有错误
- 查看后端日志
- 检查数据库中的 `system_config` 表

---

### 测试 4: 红包雨调度功能

**测试步骤**:
1. 进入 **"红包管理"** 页面
2. 点击 **"调度红包雨"** 按钮（通常在页面顶部）
3. 填写表单：
   - **开始时间**: 选择未来某个时间（例如：1小时后）
   - **总金额**: `100` USDT
   - **红包数量**: `10`
   - **目标群组ID**: 留空（公开红包）或填写 Telegram 群组 ID
   - **消息**: `测试红包雨`
4. 点击 **"确定"** 按钮

**预期结果**:
- [ ] 显示"调度成功"提示消息
- [ ] 调度记录已创建
- [ ] 可以在数据库中查看 `scheduled_redpacket_rains` 表

**验证方法**:
1. 记录调度前的记录数
2. 创建调度
3. 检查数据库中是否有新记录

**数据库验证命令**:
```bash
ssh ubuntu@165.154.254.99 "cd /home/ubuntu/hbgm001 && source .venv/bin/activate && python3 -c \"
from shared.database.connection import AsyncSessionLocal
from sqlalchemy import text
import asyncio

async def check():
    async with AsyncSessionLocal() as db:
        result = await db.execute(text('SELECT id, start_time, total_amount, packet_count, status FROM scheduled_redpacket_rains ORDER BY created_at DESC LIMIT 5'))
        rows = result.fetchall()
        print('最近5条调度记录:')
        for row in rows:
            print(f'  ID: {row[0]}, 开始时间: {row[1]}, 总金额: {row[2]}, 数量: {row[3]}, 状态: {row[4]}')

asyncio.run(check())
\""
```

**如果失败**:
- 检查浏览器控制台是否有错误
- 查看后端日志
- 检查表单验证是否通过

---

### 测试 5: 推荐关系树可视化

**测试步骤**:
1. 进入 **"邀请管理"** 页面
2. 在用户列表中找到测试用户（username 以 `test_` 开头，例如：`test_root_user`）
3. 点击该用户行的 **"查看关系树"** 按钮
4. 查看弹出的关系树模态框

**预期结果**:
- [ ] 关系树正常显示
- [ ] 可以看到3层推荐关系：
  - 第1层：`test_root_user`
  - 第2层：`test_user_1`, `test_user_2`
  - 第3层：`test_user_1_1`, `test_user_1_2`, `test_user_2_1`
- [ ] 每个节点显示用户信息（用户名、余额、等级等）

**推荐关系结构**:
```
test_root_user (id: 4)
  ├── test_user_1 (id: 5)
  │   ├── test_user_1_1 (id: 7)
  │   └── test_user_1_2 (id: 8)
  └── test_user_2 (id: 6)
      └── test_user_2_1 (id: 9)
```

**验证方法**:
1. 检查关系树是否按层级正确显示
2. 验证每个节点的用户信息是否正确
3. 检查关系连接是否正确

**如果失败**:
- 检查浏览器控制台是否有错误
- 查看后端API响应
- 验证测试数据是否存在

---

## 📊 测试结果记录

### 测试日期
___________

### 测试人员
___________

### 测试结果

| 功能 | 状态 | 备注 |
|------|------|------|
| 红包退款 | ⬜ 通过 / ⬜ 失败 | |
| 交易余额分类 | ⬜ 通过 / ⬜ 失败 | |
| 推荐系统配置 | ⬜ 通过 / ⬜ 失败 | |
| 红包雨调度 | ⬜ 通过 / ⬜ 失败 | |
| 推荐关系树 | ⬜ 通过 / ⬜ 失败 | |

### 发现问题

1. _________________________________
2. _________________________________
3. _________________________________

### 备注

_________________________________

---

## 🔍 问题排查

### 如果某个功能不工作

1. **检查浏览器控制台**
   - 按 F12 打开开发者工具
   - 查看 Console 标签中的错误信息
   - 查看 Network 标签中的请求状态

2. **检查后端服务**
   ```bash
   ssh ubuntu@165.154.254.99 "sudo systemctl status hbgm001-backend"
   ```

3. **查看后端日志**
   ```bash
   ssh ubuntu@165.154.254.99 "sudo journalctl -u hbgm001-backend -n 100 --no-pager | grep -i error"
   ```

4. **测试 API 端点**
   ```bash
   # 测试健康检查
   curl http://127.0.0.1:8080/api/v1/admin/health
   
   # 测试红包列表（需要认证）
   curl -H "Authorization: Bearer YOUR_TOKEN" http://127.0.0.1:8080/api/v1/admin/redpackets/
   ```

---

## ✅ 测试完成标准

所有功能测试完成后，应该满足：

- [x] 后台管理面板可以正常访问
- [ ] 可以正常登录
- [ ] 红包退款功能正常工作
- [ ] 交易管理显示余额分类
- [ ] 推荐系统配置可以保存和读取
- [ ] 红包雨调度功能可以创建调度记录
- [x] 推荐关系树可以正常显示

---

**开始测试**: 按照上述步骤逐一测试每个功能！

