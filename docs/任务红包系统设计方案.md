# ğŸ¯ ä»»åŠ¡çº¢åŒ…ç³»ç»Ÿè®¾è®¡æ–¹æ¡ˆ

## ğŸ“‹ ç³»ç»Ÿæ¦‚è¿°

å°†ç­¾åˆ°ã€é‚€è¯·ç­‰åŠŸèƒ½èåˆåˆ°ä»»åŠ¡çº¢åŒ…ç³»ç»Ÿä¸­ï¼Œè®©ç”¨æˆ·æ¯å¤©éƒ½å¯ä»¥é€šè¿‡å®Œæˆä»»åŠ¡é¢†å–çº¢åŒ…ï¼Œå®ç°æ‰©æ•£å’Œè£‚å˜ã€‚

---

## ğŸ—ï¸ æ•°æ®åº“è®¾è®¡

### 1. æ‰©å±• RedPacket æ¨¡å‹

```python
class RedPacketVisibility(str, enum.Enum):
    """çº¢åŒ…å¯è§æ€§"""
    PRIVATE = "private"      # ç§å¯†çº¢åŒ…ï¼ˆå‘é€åˆ°æŒ‡å®šç¾¤ç»„/ç”¨æˆ·ï¼‰
    PUBLIC = "public"        # å…¬å¼€çº¢åŒ…ï¼ˆç”¨æˆ·å‘é€çš„å…¬å¼€çº¢åŒ…ï¼‰
    TASK = "task"            # ä»»åŠ¡çº¢åŒ…
    REWARD = "reward"        # å¥–åŠ±çº¢åŒ…
    SYSTEM = "system"        # ç³»ç»Ÿçº¢åŒ…

class RedPacketSource(str, enum.Enum):
    """çº¢åŒ…æ¥æº"""
    USER_PUBLIC = "user_public"    # ç”¨æˆ·å‘é€çš„å…¬å¼€çº¢åŒ…
    USER_PRIVATE = "user_private"  # ç”¨æˆ·å‘é€çš„ç§å¯†çº¢åŒ…
    TASK = "task"                  # ä»»åŠ¡çº¢åŒ…
    REWARD = "reward"              # å¥–åŠ±çº¢åŒ…
    SYSTEM = "system"              # ç³»ç»Ÿçº¢åŒ…

# åœ¨ RedPacket è¡¨ä¸­æ·»åŠ å­—æ®µï¼š
- visibility: RedPacketVisibility (é»˜è®¤ PRIVATE)
- source_type: RedPacketSource (é»˜è®¤ USER_PRIVATE)
- task_type: String(50) (ä»»åŠ¡ç±»å‹ï¼šcheckin, invite, share, claim, sendç­‰)
- task_requirement: JSON (ä»»åŠ¡è¦æ±‚ï¼Œå¦‚ {"invite_count": 3})
- task_completed_users: JSON (å·²å®Œæˆä»»åŠ¡çš„ç”¨æˆ·IDåˆ—è¡¨)
```

### 2. æ–°å¢ TaskCompletion è¡¨

```python
class TaskCompletion(Base):
    """ä»»åŠ¡å®Œæˆè®°å½•"""
    __tablename__ = "task_completions"
    
    id = Column(Integer, primary_key=True)
    user_id = Column(Integer, ForeignKey("users.id"), nullable=False)
    red_packet_id = Column(Integer, ForeignKey("red_packets.id"), nullable=False)
    task_type = Column(String(50), nullable=False)  # checkin, invite, shareç­‰
    completed_at = Column(DateTime, default=datetime.utcnow)
    claimed_at = Column(DateTime, nullable=True)  # é¢†å–çº¢åŒ…çš„æ—¶é—´
    reward_amount = Column(Numeric(20, 8), nullable=True)  # å®é™…é¢†å–çš„é‡‘é¢
    
    # å…³è”
    user = relationship("User", back_populates="task_completions")
    red_packet = relationship("RedPacket", back_populates="task_completions")
```

### 3. æ–°å¢ DailyTask è¡¨ï¼ˆå¯é€‰ï¼‰

```python
class DailyTask(Base):
    """æ¯æ—¥ä»»åŠ¡é…ç½®"""
    __tablename__ = "daily_tasks"
    
    id = Column(Integer, primary_key=True)
    task_type = Column(String(50), unique=True, nullable=False)  # checkin, invite, shareç­‰
    task_name = Column(String(100), nullable=False)  # ä»»åŠ¡åç§°
    task_description = Column(String(500), nullable=False)  # ä»»åŠ¡æè¿°
    requirement = Column(JSON, nullable=False)  # ä»»åŠ¡è¦æ±‚
    reward_amount = Column(Numeric(20, 8), nullable=False)  # å¥–åŠ±é‡‘é¢
    reward_currency = Column(Enum(CurrencyType), default=CurrencyType.USDT)
    is_active = Column(Boolean, default=True)  # æ˜¯å¦å¯ç”¨
    sort_order = Column(Integer, default=0)  # æ’åº
    created_at = Column(DateTime, default=datetime.utcnow)
```

---

## ğŸ¯ ä»»åŠ¡ç±»å‹è®¾è®¡

### æ¯æ—¥ä»»åŠ¡ï¼ˆæ¯å¤©å¯å®Œæˆä¸€æ¬¡ï¼‰

| ä»»åŠ¡ç±»å‹ | ä»»åŠ¡åç§° | è¦æ±‚ | å¥–åŠ± | è¯´æ˜ |
|---------|---------|------|------|------|
| `checkin` | æ¯æ—¥ç­¾åˆ° | å®Œæˆç­¾åˆ° | 0.1 USDT | èåˆç°æœ‰ç­¾åˆ°åŠŸèƒ½ |
| `claim_packet` | æŠ¢çº¢åŒ… | é¢†å–1ä¸ªçº¢åŒ… | 0.05 USDT | é¼“åŠ±ç”¨æˆ·æŠ¢çº¢åŒ… |
| `send_packet` | å‘çº¢åŒ… | å‘é€1ä¸ªçº¢åŒ… | 0.1 USDT | é¼“åŠ±ç”¨æˆ·å‘çº¢åŒ… |
| `share_app` | åˆ†äº«åº”ç”¨ | åˆ†äº«1æ¬¡ | 0.05 USDT | æ¨å¹¿è£‚å˜ |
| `invite_friend` | é‚€è¯·å¥½å‹ | é‚€è¯·1ä¸ªå¥½å‹ | 0.5 USDT | èåˆç°æœ‰é‚€è¯·åŠŸèƒ½ |

### æˆå°±ä»»åŠ¡ï¼ˆä¸€æ¬¡æ€§æˆ–é‡Œç¨‹ç¢‘ï¼‰

| ä»»åŠ¡ç±»å‹ | ä»»åŠ¡åç§° | è¦æ±‚ | å¥–åŠ± | è¯´æ˜ |
|---------|---------|------|------|------|
| `invite_5` | é‚€è¯·è¾¾äºº | é‚€è¯·5ä¸ªå¥½å‹ | 2 USDT | é‡Œç¨‹ç¢‘å¥–åŠ± |
| `invite_10` | é‚€è¯·å¤§å¸ˆ | é‚€è¯·10ä¸ªå¥½å‹ | 5 USDT | é‡Œç¨‹ç¢‘å¥–åŠ± |
| `claim_10` | æŠ¢åŒ…è¾¾äºº | é¢†å–10ä¸ªçº¢åŒ… | 1 USDT | é¼“åŠ±æ´»è·ƒ |
| `send_10` | å‘åŒ…è¾¾äºº | å‘é€10ä¸ªçº¢åŒ… | 2 USDT | é¼“åŠ±æ´»è·ƒ |
| `checkin_7` | ç­¾åˆ°è¾¾äºº | è¿ç»­ç­¾åˆ°7å¤© | 1 USDT | é¼“åŠ±è¿ç»­ç­¾åˆ° |

---

## ğŸ”„ ç³»ç»Ÿæµç¨‹

### 1. ä»»åŠ¡çº¢åŒ…åˆ›å»ºæµç¨‹

```
ç³»ç»Ÿ/ç®¡ç†å‘˜åˆ›å»ºä»»åŠ¡çº¢åŒ…
    â†“
è®¾ç½®ä»»åŠ¡ç±»å‹å’Œè¦æ±‚
    â†“
åˆ›å»ºçº¢åŒ…è®°å½•ï¼ˆvisibility=TASK, source_type=TASKï¼‰
    â†“
ä¿å­˜åˆ°æ•°æ®åº“
    â†“
æ˜¾ç¤ºåœ¨å…¬å¼€çº¢åŒ…é¡µé¢ï¼ˆå¸¦ä»»åŠ¡æ ‡è¯†ï¼‰
```

### 2. ä»»åŠ¡å®Œæˆå’Œé¢†å–æµç¨‹

```
ç”¨æˆ·å®Œæˆä»»åŠ¡ï¼ˆç­¾åˆ°ã€é‚€è¯·ç­‰ï¼‰
    â†“
ç³»ç»Ÿæ£€æŸ¥ä»»åŠ¡å®ŒæˆçŠ¶æ€
    â†“
åˆ›å»º TaskCompletion è®°å½•
    â†“
ç”¨æˆ·ç‚¹å‡»"é¢†å–ä»»åŠ¡çº¢åŒ…"
    â†“
æ£€æŸ¥æ˜¯å¦å·²å®Œæˆä»»åŠ¡
    â†“
é¢†å–çº¢åŒ…ï¼ˆç±»ä¼¼æ™®é€šçº¢åŒ…é¢†å–ï¼‰
    â†“
æ›´æ–° TaskCompletion.claimed_at
    â†“
æ‰£é™¤çº¢åŒ…å‰©ä½™æ•°é‡
```

### 3. æ¯æ—¥ä»»åŠ¡è‡ªåŠ¨åˆ›å»º

```
æ¯å¤©å‡Œæ™¨ï¼ˆ00:00ï¼‰
    â†“
ç³»ç»Ÿè‡ªåŠ¨åˆ›å»ºæ¯æ—¥ä»»åŠ¡çº¢åŒ…
    â†“
ä¸ºæ¯ä¸ªä»»åŠ¡ç±»å‹åˆ›å»ºä¸€ä¸ªçº¢åŒ…æ± 
    â†“
ç”¨æˆ·å®Œæˆä»»åŠ¡åå¯ä»¥é¢†å–
```

---

## ğŸ“Š èåˆç°æœ‰åŠŸèƒ½

### 1. ç­¾åˆ°åŠŸèƒ½èåˆ

**ç°æœ‰åŠŸèƒ½**ï¼š
- ç”¨æˆ·ç­¾åˆ°è·å¾—ç§¯åˆ†ï¼ˆpointsï¼‰
- è¿ç»­ç­¾åˆ°æœ‰é€’å¢å¥–åŠ±

**èåˆæ–¹æ¡ˆ**ï¼š
- ä¿ç•™ç°æœ‰ç­¾åˆ°åŠŸèƒ½ï¼ˆç§¯åˆ†å¥–åŠ±ï¼‰
- æ·»åŠ ä»»åŠ¡çº¢åŒ…å¥–åŠ±ï¼ˆUSDTï¼‰
- å®Œæˆç­¾åˆ°åï¼Œè‡ªåŠ¨æ£€æŸ¥æ˜¯å¦å¯ä»¥é¢†å–ç­¾åˆ°ä»»åŠ¡çº¢åŒ…

**å®ç°**ï¼š
```python
# åœ¨ç­¾åˆ°APIä¸­æ·»åŠ ä»»åŠ¡çº¢åŒ…æ£€æŸ¥
@router.post("/checkin")
async def do_checkin(...):
    # ç°æœ‰ç­¾åˆ°é€»è¾‘
    user.balance_points += reward
    user.xp += reward
    
    # æ–°å¢ï¼šæ£€æŸ¥ç­¾åˆ°ä»»åŠ¡çº¢åŒ…
    await check_and_create_task_completion(
        db, user.id, "checkin", {"day": new_streak}
    )
    
    return CheckinResponse(...)
```

### 2. é‚€è¯·åŠŸèƒ½èåˆ

**ç°æœ‰åŠŸèƒ½**ï¼š
- é‚€è¯·äººå’Œè¢«é‚€è¯·äººéƒ½æœ‰USDTå¥–åŠ±
- é‚€è¯·é‡Œç¨‹ç¢‘å¥–åŠ±

**èåˆæ–¹æ¡ˆ**ï¼š
- ä¿ç•™ç°æœ‰é‚€è¯·å¥–åŠ±ï¼ˆç›´æ¥åˆ°è´¦ï¼‰
- æ·»åŠ ä»»åŠ¡çº¢åŒ…å¥–åŠ±ï¼ˆé¢å¤–å¥–åŠ±ï¼‰
- å®Œæˆé‚€è¯·åï¼Œè‡ªåŠ¨æ£€æŸ¥æ˜¯å¦å¯ä»¥é¢†å–é‚€è¯·ä»»åŠ¡çº¢åŒ…

**å®ç°**ï¼š
```python
# åœ¨é‚€è¯·å¤„ç†ä¸­æ·»åŠ ä»»åŠ¡çº¢åŒ…æ£€æŸ¥
async def handle_invite(...):
    # ç°æœ‰é‚€è¯·å¥–åŠ±é€»è¾‘
    inviter.balance_usdt += inviter_reward
    
    # æ–°å¢ï¼šæ£€æŸ¥é‚€è¯·ä»»åŠ¡çº¢åŒ…
    await check_and_create_task_completion(
        db, inviter.id, "invite_friend", {"invite_count": inviter.invite_count}
    )
    
    # æ£€æŸ¥é‡Œç¨‹ç¢‘ä»»åŠ¡
    if inviter.invite_count == 5:
        await check_and_create_task_completion(
            db, inviter.id, "invite_5", {}
        )
```

### 3. æŠ¢çº¢åŒ…åŠŸèƒ½èåˆ

**ç°æœ‰åŠŸèƒ½**ï¼š
- ç”¨æˆ·é¢†å–çº¢åŒ…è·å¾—USDT/TON/Stars

**èåˆæ–¹æ¡ˆ**ï¼š
- ä¿ç•™ç°æœ‰é¢†å–åŠŸèƒ½
- æ·»åŠ ä»»åŠ¡çº¢åŒ…å¥–åŠ±ï¼ˆé¢å¤–å¥–åŠ±ï¼‰
- é¢†å–çº¢åŒ…åï¼Œè‡ªåŠ¨æ£€æŸ¥æ˜¯å¦å¯ä»¥é¢†å–"æŠ¢çº¢åŒ…"ä»»åŠ¡çº¢åŒ…

**å®ç°**ï¼š
```python
# åœ¨é¢†å–çº¢åŒ…APIä¸­æ·»åŠ ä»»åŠ¡æ£€æŸ¥
@router.post("/{packet_uuid}/claim")
async def claim_red_packet(...):
    # ç°æœ‰é¢†å–é€»è¾‘
    claimer.balance_usdt += amount
    
    # æ–°å¢ï¼šæ£€æŸ¥æŠ¢çº¢åŒ…ä»»åŠ¡
    await check_and_create_task_completion(
        db, claimer.id, "claim_packet", {}
    )
    
    return ClaimResult(...)
```

---

## ğŸ å¥–åŠ±çº¢åŒ…ç³»ç»Ÿ

### 1. ç³»ç»Ÿè‡ªåŠ¨å‘æ”¾

**è§¦å‘æ—¶æœº**ï¼š
- æ–°ç”¨æˆ·æ³¨å†Œ
- è¾¾åˆ°ç‰¹å®šé‡Œç¨‹ç¢‘
- æ´»åŠ¨æœŸé—´

**å®ç°**ï¼š
```python
@router.post("/admin/rewards/create")
async def create_reward_packet(...):
    """åˆ›å»ºå¥–åŠ±çº¢åŒ…"""
    packet = RedPacket(
        visibility=RedPacketVisibility.PUBLIC,
        source_type=RedPacketSource.REWARD,
        chat_id=None,  # å…¬å¼€çº¢åŒ…
        total_amount=100,
        total_count=1000,  # 1000ä¸ªç”¨æˆ·å¯é¢†å–
        message="ğŸ æ–°ç”¨æˆ·æ³¨å†Œå¥–åŠ±ï¼",
        task_type="new_user",
    )
```

### 2. å¥–åŠ±çº¢åŒ…ç±»å‹

- **æ–°ç”¨æˆ·å¥–åŠ±**ï¼šæ³¨å†Œåè‡ªåŠ¨å‘æ”¾
- **æ´»åŠ¨å¥–åŠ±**ï¼šç‰¹å®šæ´»åŠ¨æœŸé—´å‘æ”¾
- **ç³»ç»Ÿå¥–åŠ±**ï¼šç³»ç»Ÿç»´æŠ¤è¡¥å¿ç­‰

---

## ğŸ¯ çº¢åŒ…æ¨èç®—æ³•

### æ¨èè§„åˆ™

1. **ç”¨æˆ·æ´»è·ƒåº¦**
   - æ ¹æ®ç”¨æˆ·ç­¾åˆ°å¤©æ•°ã€é‚€è¯·äººæ•°ã€æŠ¢åŒ…æ¬¡æ•°è®¡ç®—æ´»è·ƒåº¦
   - æ´»è·ƒç”¨æˆ·ä¼˜å…ˆæ¨èé«˜ä»·å€¼çº¢åŒ…

2. **çº¢åŒ…çƒ­åº¦**
   - æ ¹æ®å‰©ä½™æ•°é‡ã€é¢†å–é€Ÿåº¦è®¡ç®—çƒ­åº¦
   - çƒ­é—¨çº¢åŒ…ä¼˜å…ˆæ¨è

3. **ä¸ªæ€§åŒ–æ¨è**
   - æ ¹æ®ç”¨æˆ·å†å²åå¥½æ¨è
   - æ–°ç”¨æˆ·æ¨èæ–°æ‰‹ä»»åŠ¡çº¢åŒ…

### å®ç°

```python
@router.get("/recommended")
async def get_recommended_packets(
    tg_id: Optional[int] = Depends(get_tg_id_from_header),
    limit: int = 10,
    db: AsyncSession = Depends(get_db_session)
):
    """è·å–æ¨èçº¢åŒ…"""
    user = await get_user_by_tg_id(db, tg_id)
    
    # è®¡ç®—ç”¨æˆ·æ´»è·ƒåº¦
    activity_score = calculate_activity_score(user)
    
    # è·å–æ¨èçº¢åŒ…
    query = select(RedPacket).where(
        RedPacket.visibility.in_([RedPacketVisibility.PUBLIC, RedPacketVisibility.TASK]),
        RedPacket.status == RedPacketStatus.ACTIVE,
        RedPacket.expires_at > datetime.utcnow()
    )
    
    # æ ¹æ®æ´»è·ƒåº¦æ’åº
    if activity_score > 50:
        # æ´»è·ƒç”¨æˆ·ï¼šä¼˜å…ˆæ¨èé«˜ä»·å€¼çº¢åŒ…
        query = query.order_by(RedPacket.total_amount.desc())
    else:
        # æ–°ç”¨æˆ·ï¼šä¼˜å…ˆæ¨èä»»åŠ¡çº¢åŒ…
        query = query.order_by(
            case(
                (RedPacket.source_type == RedPacketSource.TASK, 0),
                else_=1
            ),
            RedPacket.created_at.desc()
        )
    
    result = await db.execute(query.limit(limit))
    return result.scalars().all()
```

---

## ğŸ“ API è®¾è®¡

### 1. åˆ›å»ºä»»åŠ¡çº¢åŒ…

```python
POST /api/admin/redpackets/create-task
{
    "task_type": "checkin",
    "task_name": "æ¯æ—¥ç­¾åˆ°",
    "task_description": "å®Œæˆç­¾åˆ°å³å¯é¢†å–çº¢åŒ…",
    "requirement": {"action": "checkin"},
    "total_amount": 10,
    "total_count": 1000,
    "currency": "USDT",
    "message": "ğŸ¯ å®Œæˆç­¾åˆ°ä»»åŠ¡ï¼Œé¢†å–çº¢åŒ…ï¼"
}
```

### 2. æ£€æŸ¥ä»»åŠ¡å®ŒæˆçŠ¶æ€

```python
GET /api/v1/tasks/status
Response: {
    "tasks": [
        {
            "task_type": "checkin",
            "task_name": "æ¯æ—¥ç­¾åˆ°",
            "completed": true,
            "can_claim": true,
            "red_packet_id": "uuid",
            "reward_amount": 0.1
        },
        ...
    ]
}
```

### 3. é¢†å–ä»»åŠ¡çº¢åŒ…

```python
POST /api/v1/tasks/{task_type}/claim
Response: {
    "success": true,
    "amount": 0.1,
    "currency": "USDT",
    "message": "é¢†å–æˆåŠŸï¼"
}
```

### 4. è·å–æ¨èçº¢åŒ…

```python
GET /api/v1/redpackets/recommended
Response: List[RedPacket]
```

---

## ğŸ¨ å‰ç«¯è®¾è®¡

### ä»»åŠ¡é¡µé¢

1. **æ¯æ—¥ä»»åŠ¡å¡ç‰‡**
   - ä»»åŠ¡å›¾æ ‡å’Œåç§°
   - å®Œæˆè¿›åº¦ï¼ˆå¦‚ï¼š1/1ï¼‰
   - å¥–åŠ±é‡‘é¢
   - "é¢†å–"æŒ‰é’®ï¼ˆå®Œæˆä¸”æœªé¢†å–æ—¶æ˜¾ç¤ºï¼‰

2. **æˆå°±ä»»åŠ¡å¡ç‰‡**
   - ä»»åŠ¡å›¾æ ‡å’Œåç§°
   - å®Œæˆè¿›åº¦ï¼ˆå¦‚ï¼š3/5ï¼‰
   - å¥–åŠ±é‡‘é¢
   - "è¿›è¡Œä¸­"æˆ–"å·²å®Œæˆ"çŠ¶æ€

3. **ä»»åŠ¡å®ŒæˆåŠ¨ç”»**
   - å®Œæˆä»»åŠ¡æ—¶æ˜¾ç¤ºåŠ¨ç”»
   - é¢†å–å¥–åŠ±æ—¶æ˜¾ç¤ºçº¢åŒ…æ‰“å¼€åŠ¨ç”»

---

## ğŸš€ å®æ–½æ­¥éª¤

### é˜¶æ®µ 1ï¼šæ•°æ®åº“è¿ç§»
1. æ·»åŠ  `visibility` å’Œ `source_type` å­—æ®µåˆ° `red_packets` è¡¨
2. åˆ›å»º `task_completions` è¡¨
3. åˆ›å»º `daily_tasks` è¡¨ï¼ˆå¯é€‰ï¼‰

### é˜¶æ®µ 2ï¼šåç«¯API
1. åˆ›å»ºä»»åŠ¡çº¢åŒ…API
2. åˆ›å»ºä»»åŠ¡å®Œæˆæ£€æŸ¥API
3. èåˆç­¾åˆ°ã€é‚€è¯·åŠŸèƒ½

### é˜¶æ®µ 3ï¼šæ¯æ—¥ä»»åŠ¡ç³»ç»Ÿ
1. å®ç°æ¯æ—¥ä»»åŠ¡è‡ªåŠ¨åˆ›å»º
2. å®ç°ä»»åŠ¡å®Œæˆæ£€æŸ¥
3. å®ç°ä»»åŠ¡çº¢åŒ…é¢†å–

### é˜¶æ®µ 4ï¼šå‰ç«¯ç•Œé¢
1. åˆ›å»ºä»»åŠ¡é¡µé¢
2. æ˜¾ç¤ºä»»åŠ¡åˆ—è¡¨å’Œå®ŒæˆçŠ¶æ€
3. å®ç°ä»»åŠ¡å®Œæˆå’Œé¢†å–åŠŸèƒ½

### é˜¶æ®µ 5ï¼šæ¨èç®—æ³•
1. å®ç°ç”¨æˆ·æ´»è·ƒåº¦è®¡ç®—
2. å®ç°çº¢åŒ…æ¨èç®—æ³•
3. å‰ç«¯æ˜¾ç¤ºæ¨èçº¢åŒ…

---

## âœ… æ€»ç»“

é€šè¿‡ä»»åŠ¡çº¢åŒ…ç³»ç»Ÿï¼Œå°†ç­¾åˆ°ã€é‚€è¯·ç­‰åŠŸèƒ½èåˆï¼Œè®©ç”¨æˆ·æ¯å¤©éƒ½å¯ä»¥é€šè¿‡å®Œæˆä»»åŠ¡é¢†å–çº¢åŒ…ï¼Œå®ç°ï¼š
- âœ… æå‡ç”¨æˆ·æ´»è·ƒåº¦
- âœ… ä¿ƒè¿›ç”¨æˆ·æ‰©æ•£å’Œè£‚å˜
- âœ… å¢åŠ ç”¨æˆ·ç²˜æ€§
- âœ… æå‡å¹³å°æ´»è·ƒåº¦

