# ğŸ¯ å…¬å¼€çº¢åŒ…é¡µé¢è®¾è®¡æ–¹æ¡ˆ

## ğŸ“‹ éœ€æ±‚åˆ†æ

### å½“å‰é—®é¢˜
- å‘é€åˆ°æŒ‡å®šç¾¤ç»„æˆ–æŒ‡å®šç”¨æˆ·çš„çº¢åŒ…ä¸åº”è¯¥æ˜¾ç¤ºåœ¨å…¬å¼€çº¢åŒ…é¡µé¢
- å…¬å¼€çº¢åŒ…é¡µé¢åº”è¯¥åªæ˜¾ç¤ºï¼š
  - **ä»»åŠ¡çº¢åŒ…** - å®Œæˆç‰¹å®šä»»åŠ¡åå¯ä»¥é¢†å–
  - **å¥–åŠ±çº¢åŒ…** - ç³»ç»Ÿå¥–åŠ±ã€æ´»åŠ¨å¥–åŠ±ç­‰
  - **éšæœºçº¢åŒ…** - ç”¨æˆ·ä¸»åŠ¨å‘é€çš„å…¬å¼€çº¢åŒ…

### ç›®æ ‡
- è®©æ›´å¤šäººå‚ä¸æŠ¢çº¢åŒ…
- å®Œæˆæ‰©æ•£å’Œè£‚å˜ä»»åŠ¡
- æå‡ç”¨æˆ·æ´»è·ƒåº¦

---

## ğŸ—ï¸ è®¾è®¡æ–¹æ¡ˆ

### 1. çº¢åŒ…å¯è§æ€§åˆ†ç±»

#### æ–¹æ¡ˆ Aï¼šä½¿ç”¨ `chat_id` åˆ¤æ–­ï¼ˆç®€å•æ–¹æ¡ˆï¼‰
- `chat_id = NULL` â†’ å…¬å¼€çº¢åŒ…ï¼ˆæ˜¾ç¤ºåœ¨é¡µé¢ï¼‰
- `chat_id != NULL` â†’ ç§å¯†çº¢åŒ…ï¼ˆä¸æ˜¾ç¤ºåœ¨é¡µé¢ï¼‰

**ä¼˜ç‚¹**ï¼šæ— éœ€ä¿®æ”¹æ•°æ®åº“ç»“æ„  
**ç¼ºç‚¹**ï¼šæ— æ³•åŒºåˆ†ä»»åŠ¡çº¢åŒ…å’Œå¥–åŠ±çº¢åŒ…

#### æ–¹æ¡ˆ Bï¼šæ·»åŠ  `visibility` å­—æ®µï¼ˆæ¨èæ–¹æ¡ˆï¼‰
```python
class RedPacketVisibility(str, enum.Enum):
    PRIVATE = "private"      # ç§å¯†çº¢åŒ…ï¼ˆå‘é€åˆ°æŒ‡å®šç¾¤ç»„/ç”¨æˆ·ï¼‰
    PUBLIC = "public"        # å…¬å¼€çº¢åŒ…ï¼ˆæ˜¾ç¤ºåœ¨å…¬å¼€é¡µé¢ï¼‰
    TASK = "task"            # ä»»åŠ¡çº¢åŒ…
    REWARD = "reward"        # å¥–åŠ±çº¢åŒ…
```

**ä¼˜ç‚¹**ï¼šæ¸…æ™°åŒºåˆ†ä¸åŒç±»å‹ï¼Œæ˜“äºæ‰©å±•  
**ç¼ºç‚¹**ï¼šéœ€è¦æ•°æ®åº“è¿ç§»

#### æ–¹æ¡ˆ Cï¼šæ·»åŠ  `source_type` å­—æ®µï¼ˆå®Œæ•´æ–¹æ¡ˆï¼‰
```python
class RedPacketSource(str, enum.Enum):
    USER_PUBLIC = "user_public"    # ç”¨æˆ·å‘é€çš„å…¬å¼€çº¢åŒ…
    USER_PRIVATE = "user_private"  # ç”¨æˆ·å‘é€çš„ç§å¯†çº¢åŒ…
    TASK = "task"                  # ä»»åŠ¡çº¢åŒ…
    REWARD = "reward"              # å¥–åŠ±çº¢åŒ…
    SYSTEM = "system"              # ç³»ç»Ÿçº¢åŒ…
```

**ä¼˜ç‚¹**ï¼šæœ€å®Œæ•´ï¼Œæ”¯æŒæ‰€æœ‰åœºæ™¯  
**ç¼ºç‚¹**ï¼šéœ€è¦æ•°æ®åº“è¿ç§»

---

### 2. æ¨èæ–¹æ¡ˆï¼šæ–¹æ¡ˆ B + æ–¹æ¡ˆ C ç»“åˆ

#### æ•°æ®åº“å­—æ®µè®¾è®¡
```python
class RedPacket(Base):
    # ... ç°æœ‰å­—æ®µ ...
    
    # æ–°å¢å­—æ®µ
    visibility = Column(Enum(RedPacketVisibility), default=RedPacketVisibility.PRIVATE)
    source_type = Column(Enum(RedPacketSource), default=RedPacketSource.USER_PRIVATE)
    
    # ä»»åŠ¡ç›¸å…³ï¼ˆä»…å½“ source_type = TASK æ—¶ä½¿ç”¨ï¼‰
    task_type = Column(String(50), nullable=True)  # ä»»åŠ¡ç±»å‹ï¼šinvite, checkin, shareç­‰
    task_requirement = Column(JSON, nullable=True)  # ä»»åŠ¡è¦æ±‚ï¼ˆJSONæ ¼å¼ï¼‰
    task_completed_users = Column(JSON, default=list)  # å·²å®Œæˆä»»åŠ¡çš„ç”¨æˆ·IDåˆ—è¡¨
```

#### çº¢åŒ…ç±»å‹è¯´æ˜

| ç±»å‹ | visibility | source_type | chat_id | è¯´æ˜ |
|------|-----------|-------------|---------|------|
| å…¬å¼€éšæœºçº¢åŒ… | PUBLIC | USER_PUBLIC | NULL | ç”¨æˆ·ä¸»åŠ¨å‘é€çš„å…¬å¼€çº¢åŒ… |
| ç§å¯†ç¾¤ç»„çº¢åŒ… | PRIVATE | USER_PRIVATE | æœ‰å€¼ | å‘é€åˆ°æŒ‡å®šç¾¤ç»„çš„çº¢åŒ… |
| ç§å¯†ç”¨æˆ·çº¢åŒ… | PRIVATE | USER_PRIVATE | æœ‰å€¼ | å‘é€ç»™æŒ‡å®šç”¨æˆ·çš„çº¢åŒ… |
| ä»»åŠ¡çº¢åŒ… | PUBLIC | TASK | NULL | å®Œæˆç‰¹å®šä»»åŠ¡åå¯é¢†å– |
| å¥–åŠ±çº¢åŒ… | PUBLIC | REWARD | NULL | ç³»ç»Ÿå¥–åŠ±ã€æ´»åŠ¨å¥–åŠ± |
| ç³»ç»Ÿçº¢åŒ… | PUBLIC | SYSTEM | NULL | ç³»ç»Ÿå‘æ”¾çš„å…¬å¼€çº¢åŒ… |

---

## ğŸ”„ å®ç°æ–¹æ¡ˆ

### é˜¶æ®µ 1ï¼šå¿«é€Ÿå®ç°ï¼ˆä½¿ç”¨ç°æœ‰å­—æ®µï¼‰

**åˆ¤æ–­é€»è¾‘**ï¼š
- `chat_id IS NULL` â†’ å…¬å¼€çº¢åŒ…ï¼ˆæ˜¾ç¤ºï¼‰
- `chat_id IS NOT NULL` â†’ ç§å¯†çº¢åŒ…ï¼ˆä¸æ˜¾ç¤ºï¼‰

**ä¿®æ”¹åç«¯ API**ï¼š
```python
@router.get("/list", response_model=List[RedPacketResponse])
async def list_red_packets(...):
    # åªè¿”å›å…¬å¼€çº¢åŒ…ï¼ˆchat_id ä¸º NULLï¼‰
    query = select(RedPacket).where(
        RedPacket.chat_id.is_(None),  # åªæ˜¾ç¤ºå…¬å¼€çº¢åŒ…
        RedPacket.status == RedPacketStatus.ACTIVE,
        RedPacket.expires_at > datetime.utcnow()
    ).order_by(RedPacket.created_at.desc()).limit(limit)
```

### é˜¶æ®µ 2ï¼šå®Œæ•´å®ç°ï¼ˆæ·»åŠ æ–°å­—æ®µï¼‰

#### 2.1 æ•°æ®åº“è¿ç§»
```python
# migrations/add_redpacket_visibility.py
def upgrade():
    op.add_column('red_packets', 
        sa.Column('visibility', sa.Enum('PRIVATE', 'PUBLIC', 'TASK', 'REWARD', name='redpacketvisibility'), 
                  nullable=False, server_default='PRIVATE'))
    op.add_column('red_packets',
        sa.Column('source_type', sa.Enum('USER_PUBLIC', 'USER_PRIVATE', 'TASK', 'REWARD', 'SYSTEM', name='redpacketsource'),
                  nullable=False, server_default='USER_PRIVATE'))
    op.add_column('red_packets',
        sa.Column('task_type', sa.String(50), nullable=True))
    op.add_column('red_packets',
        sa.Column('task_requirement', sa.JSON, nullable=True))
```

#### 2.2 ä¿®æ”¹åç«¯ API
```python
@router.get("/list", response_model=List[RedPacketResponse])
async def list_red_packets(...):
    # åªè¿”å›å…¬å¼€å¯è§çš„çº¢åŒ…
    query = select(RedPacket).where(
        RedPacket.visibility.in_([
            RedPacketVisibility.PUBLIC,
            RedPacketVisibility.TASK,
            RedPacketVisibility.REWARD
        ]),
        RedPacket.status == RedPacketStatus.ACTIVE,
        RedPacket.expires_at > datetime.utcnow()
    ).order_by(RedPacket.created_at.desc()).limit(limit)
```

#### 2.3 ä¿®æ”¹åˆ›å»ºçº¢åŒ…é€»è¾‘
```python
@router.post("/create")
async def create_red_packet(request: CreateRedPacketRequest, ...):
    # åˆ¤æ–­çº¢åŒ…å¯è§æ€§
    if request.chat_id is None:
        # å…¬å¼€çº¢åŒ…
        visibility = RedPacketVisibility.PUBLIC
        source_type = RedPacketSource.USER_PUBLIC
    else:
        # ç§å¯†çº¢åŒ…
        visibility = RedPacketVisibility.PRIVATE
        source_type = RedPacketSource.USER_PRIVATE
    
    packet = RedPacket(
        # ... ç°æœ‰å­—æ®µ ...
        visibility=visibility,
        source_type=source_type,
        chat_id=request.chat_id,  # å…¬å¼€çº¢åŒ…æ—¶è®¾ä¸º NULL
    )
```

---

## ğŸ ä»»åŠ¡çº¢åŒ…å’Œå¥–åŠ±çº¢åŒ…è®¾è®¡

### ä»»åŠ¡çº¢åŒ…ç±»å‹

#### 1. é‚€è¯·ä»»åŠ¡çº¢åŒ…
```python
{
    "source_type": "TASK",
    "task_type": "invite",
    "task_requirement": {
        "invite_count": 3,  # éœ€è¦é‚€è¯·3ä¸ªç”¨æˆ·
        "reward_amount": 10,  # å¥–åŠ±é‡‘é¢
        "currency": "USDT"
    }
}
```

#### 2. ç­¾åˆ°ä»»åŠ¡çº¢åŒ…
```python
{
    "source_type": "TASK",
    "task_type": "checkin",
    "task_requirement": {
        "checkin_days": 7,  # è¿ç»­ç­¾åˆ°7å¤©
        "reward_amount": 5,
        "currency": "USDT"
    }
}
```

#### 3. åˆ†äº«ä»»åŠ¡çº¢åŒ…
```python
{
    "source_type": "TASK",
    "task_type": "share",
    "task_requirement": {
        "share_count": 5,  # åˆ†äº«5æ¬¡
        "reward_amount": 3,
        "currency": "USDT"
    }
}
```

### å¥–åŠ±çº¢åŒ…ç±»å‹

#### 1. æ–°ç”¨æˆ·å¥–åŠ±
```python
{
    "source_type": "REWARD",
    "task_type": "new_user",
    "total_amount": 1,
    "total_count": 1000,  # 1000ä¸ªæ–°ç”¨æˆ·å¯é¢†å–
    "currency": "USDT"
}
```

#### 2. æ´»åŠ¨å¥–åŠ±
```python
{
    "source_type": "REWARD",
    "task_type": "event",
    "total_amount": 100,
    "total_count": 100,
    "currency": "USDT"
}
```

#### 3. ç³»ç»Ÿå¥–åŠ±
```python
{
    "source_type": "SYSTEM",
    "task_type": "system_bonus",
    "total_amount": 50,
    "total_count": 200,
    "currency": "USDT"
}
```

---

## ğŸ“Š å‰ç«¯æ˜¾ç¤ºä¼˜åŒ–

### çº¢åŒ…å¡ç‰‡æ ‡è¯†

```typescript
// æ ¹æ® source_type æ˜¾ç¤ºä¸åŒæ ‡è¯†
const getPacketBadge = (packet: RedPacket) => {
  switch (packet.source_type) {
    case 'TASK':
      return { label: 'ä»»åŠ¡çº¢åŒ…', color: 'purple', icon: 'ğŸ¯' }
    case 'REWARD':
      return { label: 'å¥–åŠ±çº¢åŒ…', color: 'gold', icon: 'ğŸ' }
    case 'SYSTEM':
      return { label: 'ç³»ç»Ÿçº¢åŒ…', color: 'blue', icon: 'âš™ï¸' }
    case 'USER_PUBLIC':
      return { label: 'éšæœºçº¢åŒ…', color: 'orange', icon: 'ğŸ§§' }
    default:
      return null
  }
}
```

### ä»»åŠ¡çº¢åŒ…ç‰¹æ®Šå¤„ç†

```typescript
// ä»»åŠ¡çº¢åŒ…éœ€è¦å…ˆå®Œæˆä»»åŠ¡æ‰èƒ½é¢†å–
const canClaimTaskPacket = (packet: RedPacket, user: User) => {
  if (packet.source_type !== 'TASK') return true
  
  // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å®Œæˆä»»åŠ¡
  switch (packet.task_type) {
    case 'invite':
      return user.invite_count >= packet.task_requirement.invite_count
    case 'checkin':
      return user.checkin_streak >= packet.task_requirement.checkin_days
    case 'share':
      // æ£€æŸ¥åˆ†äº«æ¬¡æ•°
      return checkUserShareCount(user.id) >= packet.task_requirement.share_count
    default:
      return false
  }
}
```

---

## ğŸš€ å®æ–½æ­¥éª¤

### ç¬¬ä¸€æ­¥ï¼šå¿«é€Ÿä¿®å¤ï¼ˆç«‹å³å®æ–½ï¼‰
1. âœ… ä¿®æ”¹åç«¯ APIï¼Œåªè¿”å› `chat_id IS NULL` çš„çº¢åŒ…
2. âœ… æµ‹è¯•å…¬å¼€çº¢åŒ…æ˜¾ç¤º
3. âœ… ç¡®ä¿ç§å¯†çº¢åŒ…ä¸æ˜¾ç¤º

### ç¬¬äºŒæ­¥ï¼šæ•°æ®åº“è¿ç§»ï¼ˆåç»­ä¼˜åŒ–ï¼‰
1. åˆ›å»ºæ•°æ®åº“è¿ç§»è„šæœ¬
2. æ·»åŠ  `visibility` å’Œ `source_type` å­—æ®µ
3. è¿ç§»ç°æœ‰æ•°æ®ï¼ˆæ ¹æ® `chat_id` è®¾ç½®é»˜è®¤å€¼ï¼‰

### ç¬¬ä¸‰æ­¥ï¼šä»»åŠ¡çº¢åŒ…åŠŸèƒ½ï¼ˆæ‰©å±•åŠŸèƒ½ï¼‰
1. åˆ›å»ºä»»åŠ¡çº¢åŒ… API
2. å®ç°ä»»åŠ¡å®Œæˆæ£€æŸ¥é€»è¾‘
3. å‰ç«¯æ˜¾ç¤ºä»»åŠ¡çº¢åŒ…å’Œå®ŒæˆçŠ¶æ€

### ç¬¬å››æ­¥ï¼šå¥–åŠ±çº¢åŒ…åŠŸèƒ½ï¼ˆæ‰©å±•åŠŸèƒ½ï¼‰
1. åˆ›å»ºå¥–åŠ±çº¢åŒ… API
2. å®ç°ç³»ç»Ÿå‘æ”¾å¥–åŠ±çº¢åŒ…
3. å‰ç«¯æ˜¾ç¤ºå¥–åŠ±çº¢åŒ…

---

## ğŸ“ API è®¾è®¡

### åˆ›å»ºå…¬å¼€çº¢åŒ…
```python
POST /api/redpackets/create
{
    "currency": "usdt",
    "packet_type": "random",
    "total_amount": 10,
    "total_count": 5,
    "message": "æ­å–œç™¼è²¡ï¼ğŸ§§",
    "chat_id": null,  # è®¾ä¸º null è¡¨ç¤ºå…¬å¼€çº¢åŒ…
    "visibility": "PUBLIC"  # å¯é€‰ï¼Œé»˜è®¤æ ¹æ® chat_id åˆ¤æ–­
}
```

### åˆ›å»ºä»»åŠ¡çº¢åŒ…
```python
POST /api/admin/redpackets/create-task
{
    "currency": "usdt",
    "total_amount": 100,
    "total_count": 1000,
    "message": "å®Œæˆé‚€è¯·ä»»åŠ¡å³å¯é¢†å–ï¼",
    "task_type": "invite",
    "task_requirement": {
        "invite_count": 3
    }
}
```

### åˆ›å»ºå¥–åŠ±çº¢åŒ…
```python
POST /api/admin/redpackets/create-reward
{
    "currency": "usdt",
    "total_amount": 50,
    "total_count": 200,
    "message": "æ–°ç”¨æˆ·æ³¨å†Œå¥–åŠ±ï¼",
    "source_type": "REWARD",
    "task_type": "new_user"
}
```

---

## âœ… æ€»ç»“

### æ ¸å¿ƒåŸåˆ™
1. **å…¬å¼€çº¢åŒ…**ï¼š`chat_id IS NULL` æˆ– `visibility = PUBLIC`
2. **ç§å¯†çº¢åŒ…**ï¼š`chat_id IS NOT NULL` æˆ– `visibility = PRIVATE`
3. **ä»»åŠ¡çº¢åŒ…**ï¼šéœ€è¦å®Œæˆä»»åŠ¡æ‰èƒ½é¢†å–
4. **å¥–åŠ±çº¢åŒ…**ï¼šç³»ç»Ÿè‡ªåŠ¨å‘æ”¾ï¼Œç”¨æˆ·ç›´æ¥é¢†å–

### å®æ–½ä¼˜å…ˆçº§
1. **P0ï¼ˆç«‹å³ï¼‰**ï¼šä¿®æ”¹ API åªè¿”å›å…¬å¼€çº¢åŒ…
2. **P1ï¼ˆæœ¬å‘¨ï¼‰**ï¼šæ·»åŠ æ•°æ®åº“å­—æ®µï¼Œå®Œå–„åˆ†ç±»
3. **P2ï¼ˆåç»­ï¼‰**ï¼šå®ç°ä»»åŠ¡çº¢åŒ…å’Œå¥–åŠ±çº¢åŒ…åŠŸèƒ½

