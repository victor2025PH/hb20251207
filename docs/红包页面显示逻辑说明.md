# ğŸ§§ çº¢åŒ…é¡µé¢æ˜¾ç¤ºé€»è¾‘è¯´æ˜

## ğŸ“‹ æ¦‚è¿°

çº¢åŒ…é¡µé¢ï¼ˆPacketsPageï¼‰æ˜¾ç¤ºæ‰€æœ‰**æ´»è·ƒçŠ¶æ€**çš„çº¢åŒ…ï¼Œç”¨æˆ·å¯ä»¥åœ¨è¯¥é¡µé¢æŸ¥çœ‹å’Œé¢†å–çº¢åŒ…ã€‚

## ğŸ”„ å®Œæ•´æµç¨‹

### 1. çº¢åŒ…å‘é€æµç¨‹

#### æ­¥éª¤ 1ï¼šç”¨æˆ·åœ¨ MiniApp ä¸­å‘é€çº¢åŒ…
- ç”¨æˆ·è¿›å…¥"å‘é€çº¢åŒ…"é¡µé¢
- é€‰æ‹©ç¾¤ç»„/ç”¨æˆ·ã€é‡‘é¢ã€æ•°é‡ã€ç±»å‹ç­‰
- ç‚¹å‡»å‘é€

#### æ­¥éª¤ 2ï¼šå‰ç«¯è°ƒç”¨ API
```typescript
// frontend/src/utils/api.ts
POST /api/redpackets/create
{
  currency: "usdt",
  packet_type: "random",
  total_amount: 10,
  total_count: 5,
  message: "æ­å–œç™¼è²¡ï¼ğŸ§§",
  chat_id: 123456789,
  chat_title: "æµ‹è¯•ç¾¤ç»„"
}
```

#### æ­¥éª¤ 3ï¼šåç«¯åˆ›å»ºçº¢åŒ…
```python
# api/routers/redpackets.py
@router.post("/create")
async def create_red_packet(...)
```

åç«¯ä¼šï¼š
1. âœ… éªŒè¯ç”¨æˆ·ä½™é¢
2. âœ… æ‰£é™¤ç”¨æˆ·ä½™é¢
3. âœ… åˆ›å»ºçº¢åŒ…è®°å½•ï¼ˆçŠ¶æ€ï¼š`ACTIVE`ï¼‰
4. âœ… å‘é€åˆ° Telegram ç¾¤ç»„ï¼ˆå¦‚æœæœºå™¨äºº in ç¾¤ç»„ï¼‰
5. âœ… è¿”å›çº¢åŒ…ä¿¡æ¯

#### æ­¥éª¤ 4ï¼šçº¢åŒ…ä¿å­˜åˆ°æ•°æ®åº“
```sql
INSERT INTO red_packets (
  uuid, sender_id, currency, packet_type,
  total_amount, total_count, message,
  chat_id, chat_title, status, created_at, expires_at
) VALUES (...)
```

**å…³é”®ç‚¹**ï¼š
- `status` = `ACTIVE`ï¼ˆæ´»è·ƒçŠ¶æ€ï¼‰
- `expires_at` = åˆ›å»ºæ—¶é—´ + 24å°æ—¶
- `chat_id` å’Œ `chat_title` ä¼šè¢«ä¿å­˜ï¼ˆç”¨äºæ˜¾ç¤ºæ¥æºç¾¤ç»„ï¼‰

---

### 2. çº¢åŒ…åˆ—è¡¨æ˜¾ç¤ºæµç¨‹

#### æ­¥éª¤ 1ï¼šå‰ç«¯è¯·æ±‚çº¢åŒ…åˆ—è¡¨
```typescript
// frontend/src/pages/PacketsPage.tsx
const { data: rawPackets } = useQuery({
  queryKey: ['redpackets'],
  queryFn: listRedPackets,  // è°ƒç”¨ API
  staleTime: 10000,         // 10ç§’ç¼“å­˜
  refetchInterval: 30000,   // 30ç§’è‡ªåŠ¨åˆ·æ–°
})
```

#### æ­¥éª¤ 2ï¼šAPI è°ƒç”¨
```typescript
// frontend/src/utils/api.ts
export async function listRedPackets(): Promise<RedPacket[]> {
  return api.get('/v1/redpackets')  // âš ï¸ æ³¨æ„ï¼šè¿™é‡Œè°ƒç”¨çš„æ˜¯ /v1/redpackets
}
```

**âš ï¸ é—®é¢˜**ï¼šå‰ç«¯è°ƒç”¨çš„æ˜¯ `/v1/redpackets`ï¼Œä½†åç«¯æ³¨å†Œçš„è·¯ç”±æ˜¯ `/api/redpackets/list`

#### æ­¥éª¤ 3ï¼šåç«¯è¿”å›çº¢åŒ…åˆ—è¡¨
```python
# api/routers/redpackets.py
@router.get("/list", response_model=List[RedPacketResponse])
async def list_red_packets(
    status: Optional[RedPacketStatus] = None,
    chat_id: Optional[int] = None,
    limit: int = 20,
    db: AsyncSession = Depends(get_db_session)
):
    """ç²å–ç´…åŒ…åˆ—è¡¨"""
    query = select(RedPacket).order_by(RedPacket.created_at.desc()).limit(limit)
    
    if status:
        query = query.where(RedPacket.status == status)
    if chat_id:
        query = query.where(RedPacket.chat_id == chat_id)
    
    result = await db.execute(query)
    packets = result.scalars().all()
    
    return packets
```

**è¿”å›æ¡ä»¶**ï¼š
- é»˜è®¤è¿”å›æ‰€æœ‰çº¢åŒ…ï¼ˆä¸é™åˆ¶çŠ¶æ€ï¼‰
- æŒ‰åˆ›å»ºæ—¶é—´å€’åºæ’åˆ—
- é»˜è®¤é™åˆ¶ 20 æ¡
- å¯ä»¥æŒ‰ `status` è¿‡æ»¤ï¼ˆ`ACTIVE`, `COMPLETED`, `EXPIRED`ï¼‰
- å¯ä»¥æŒ‰ `chat_id` è¿‡æ»¤ï¼ˆç‰¹å®šç¾¤ç»„ï¼‰

#### æ­¥éª¤ 4ï¼šå‰ç«¯æ˜¾ç¤ºçº¢åŒ…
```typescript
// frontend/src/pages/PacketsPage.tsx
const packets: PacketDisplay[] = (rawPackets || []).map(convertToDisplay)

// è¿‡æ»¤æ˜¾ç¤º
const filteredPackets = packets.filter((packet) => {
  if (activeTab === 'all') return true
  if (activeTab === 'crypto') return packet.currency === 'USDT' || packet.currency === 'TON'
  if (activeTab === 'points') return packet.currency === 'Stars'
  return true
})
```

---

## ğŸ¯ çº¢åŒ…æ˜¾ç¤ºçš„æ¡ä»¶

### çº¢åŒ…ä¼šå‡ºç°åœ¨é¡µé¢çš„æ¡ä»¶ï¼š

1. âœ… **çº¢åŒ…å·²åˆ›å»º**ï¼ˆåœ¨æ•°æ®åº“ä¸­ï¼‰
2. âœ… **çº¢åŒ…çŠ¶æ€**ï¼š
   - `ACTIVE` - æ´»è·ƒï¼ˆå¯ä»¥é¢†å–ï¼‰
   - `COMPLETED` - å·²å®Œæˆï¼ˆå·²é¢†å®Œï¼‰
   - `EXPIRED` - å·²è¿‡æœŸ
   
   **æ³¨æ„**ï¼šåç«¯é»˜è®¤è¿”å›æ‰€æœ‰çŠ¶æ€çš„çº¢åŒ…ï¼Œå‰ç«¯ä¼šè¿‡æ»¤æ˜¾ç¤º

3. âœ… **çº¢åŒ…æœªè¿‡æœŸ**ï¼ˆ`expires_at > å½“å‰æ—¶é—´`ï¼‰
   - è™½ç„¶è¿‡æœŸçº¢åŒ…ä¹Ÿä¼šè¿”å›ï¼Œä½†å‰ç«¯ä¼šæ ‡è®°ä¸º"å·²è¿‡æœŸ"

4. âœ… **çº¢åŒ…æœ‰å‰©ä½™**ï¼ˆ`remaining > 0`ï¼‰
   - å¦‚æœ `remaining === 0`ï¼Œå‰ç«¯ä¼šæ˜¾ç¤º"å·²é¢†å®Œ"

### çº¢åŒ…ä¸ä¼šå‡ºç°åœ¨é¡µé¢çš„æƒ…å†µï¼š

1. âŒ **çº¢åŒ…ä¸å­˜åœ¨**ï¼ˆæœªåˆ›å»ºï¼‰
2. âŒ **API è°ƒç”¨å¤±è´¥**ï¼ˆç½‘ç»œé”™è¯¯ã€è®¤è¯å¤±è´¥ç­‰ï¼‰
3. âŒ **æ•°æ®åº“æŸ¥è¯¢å¤±è´¥**

---

## ğŸ” å½“å‰é—®é¢˜åˆ†æ

### é—®é¢˜ 1ï¼šAPI è·¯å¾„ä¸åŒ¹é…

**å‰ç«¯è°ƒç”¨**ï¼š
```typescript
api.get('/v1/redpackets')
```

**åç«¯è·¯ç”±**ï¼š
```python
@router.get("/list")  # å®Œæ•´è·¯å¾„ï¼š/api/redpackets/list
```

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. ä¿®æ”¹å‰ç«¯è°ƒç”¨è·¯å¾„ä¸º `/api/redpackets/list`
2. æˆ–è€…æ·»åŠ  `/v1/redpackets` è·¯ç”±åˆ°åç«¯

### é—®é¢˜ 2ï¼šé»˜è®¤è¿”å›æ‰€æœ‰çŠ¶æ€çš„çº¢åŒ…

åç«¯é»˜è®¤è¿”å›æ‰€æœ‰çŠ¶æ€çš„çº¢åŒ…ï¼ŒåŒ…æ‹¬ï¼š
- `ACTIVE` - å¯ä»¥é¢†å–
- `COMPLETED` - å·²é¢†å®Œ
- `EXPIRED` - å·²è¿‡æœŸ

**å»ºè®®**ï¼šé»˜è®¤åªè¿”å› `ACTIVE` çŠ¶æ€çš„çº¢åŒ…

---

## ğŸ› ï¸ ä¿®å¤å»ºè®®

### ä¿®å¤ 1ï¼šç»Ÿä¸€ API è·¯å¾„

**æ–¹æ¡ˆ Aï¼šä¿®æ”¹å‰ç«¯**
```typescript
// frontend/src/utils/api.ts
export async function listRedPackets(): Promise<RedPacket[]> {
  return api.get('/api/redpackets/list')  // ä¿®æ”¹ä¸ºæ­£ç¡®çš„è·¯å¾„
}
```

**æ–¹æ¡ˆ Bï¼šæ·»åŠ å…¼å®¹è·¯ç”±**
```python
# api/routers/redpackets.py
@router.get("", response_model=List[RedPacketResponse])
@router.get("/", response_model=List[RedPacketResponse])
async def list_red_packets_v1(...):
    # å…¼å®¹ /v1/redpackets è·¯å¾„
    return await list_red_packets(...)
```

### ä¿®å¤ 2ï¼šé»˜è®¤åªè¿”å›æ´»è·ƒçº¢åŒ…

```python
# api/routers/redpackets.py
@router.get("/list", response_model=List[RedPacketResponse])
async def list_red_packets(
    status: Optional[RedPacketStatus] = RedPacketStatus.ACTIVE,  # é»˜è®¤åªè¿”å›æ´»è·ƒçº¢åŒ…
    chat_id: Optional[int] = None,
    limit: int = 20,
    db: AsyncSession = Depends(get_db_session)
):
    """ç²å–ç´…åŒ…åˆ—è¡¨"""
    query = select(RedPacket).order_by(RedPacket.created_at.desc()).limit(limit)
    
    # é»˜è®¤åªè¿”å›æ´»è·ƒçº¢åŒ…
    if status is None:
        status = RedPacketStatus.ACTIVE
    query = query.where(RedPacket.status == status)
    
    if chat_id:
        query = query.where(RedPacket.chat_id == chat_id)
    
    # è¿‡æ»¤è¿‡æœŸçº¢åŒ…
    query = query.where(RedPacket.expires_at > datetime.utcnow())
    
    result = await db.execute(query)
    packets = result.scalars().all()
    
    return packets
```

---

## ğŸ“Š æ•°æ®æµå›¾

```
ç”¨æˆ·å‘é€çº¢åŒ…
    â†“
POST /api/redpackets/create
    â†“
åˆ›å»ºçº¢åŒ…è®°å½•ï¼ˆstatus=ACTIVEï¼‰
    â†“
ä¿å­˜åˆ°æ•°æ®åº“
    â†“
è¿”å›çº¢åŒ…ä¿¡æ¯
    â†“
å‰ç«¯åˆ·æ–°åˆ—è¡¨
    â†“
GET /api/redpackets/list (æˆ– /v1/redpackets)
    â†“
æŸ¥è¯¢æ•°æ®åº“ï¼ˆstatus=ACTIVEï¼‰
    â†“
è¿”å›çº¢åŒ…åˆ—è¡¨
    â†“
å‰ç«¯æ˜¾ç¤ºçº¢åŒ…
```

---

## âœ… æ€»ç»“

**çº¢åŒ…å‡ºç°åœ¨é¡µé¢çš„æ¡ä»¶**ï¼š
1. âœ… çº¢åŒ…å·²åˆ›å»ºå¹¶ä¿å­˜åˆ°æ•°æ®åº“
2. âœ… çº¢åŒ…çŠ¶æ€ä¸º `ACTIVE`ï¼ˆæˆ–åç«¯è¿”å›æ‰€æœ‰çŠ¶æ€ï¼‰
3. âœ… çº¢åŒ…æœªè¿‡æœŸï¼ˆ`expires_at > å½“å‰æ—¶é—´`ï¼‰
4. âœ… API è°ƒç”¨æˆåŠŸ
5. âœ… å‰ç«¯æ­£ç¡®è§£æå’Œæ˜¾ç¤º

**å½“å‰å¯èƒ½çš„é—®é¢˜**ï¼š
- âš ï¸ API è·¯å¾„ä¸åŒ¹é…ï¼ˆå‰ç«¯ `/v1/redpackets` vs åç«¯ `/api/redpackets/list`ï¼‰
- âš ï¸ åç«¯è¿”å›æ‰€æœ‰çŠ¶æ€çš„çº¢åŒ…ï¼ˆåŒ…æ‹¬å·²è¿‡æœŸã€å·²é¢†å®Œçš„ï¼‰

**å»ºè®®ä¿®å¤**ï¼š
1. ç»Ÿä¸€ API è·¯å¾„
2. é»˜è®¤åªè¿”å›æ´»è·ƒçº¢åŒ…
3. æ·»åŠ è¿‡æœŸæ—¶é—´è¿‡æ»¤

