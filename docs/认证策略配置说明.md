# 认证策略配置说明

## 概述

系统现在支持基于请求来源（host/port）的智能认证策略选择，允许不同端口使用不同的认证方式。

## 认证策略类型

### 1. `telegram_first` - Telegram 优先策略
- **适用环境**: MiniApp 环境
- **认证顺序**:
  1. 优先使用 Telegram `initData` 认证
  2. 如果 Telegram 认证失败，回退到 JWT Token
- **适用域名/端口**:
  - `mini.usdt2026.cc`
  - `localhost:5173` (开发环境)
  - `localhost:3000` (开发环境)

### 2. `jwt_only` - 仅 JWT Token 策略
- **适用环境**: Web 管理后台
- **认证方式**: 只使用 JWT Token 认证
- **适用域名/端口**:
  - `admin.usdt2026.cc`
  - `localhost:5174` (开发环境)
  - `localhost:3001` (开发环境)

### 3. `both` - 双重认证策略（默认）
- **适用环境**: 其他环境
- **认证顺序**:
  1. 优先使用 JWT Token
  2. 如果 JWT 失败，回退到 Telegram `initData`
- **适用域名**: 所有未明确配置的域名

## 配置方法

### 添加新的域名/端口

编辑 `api/utils/auth_strategy.py` 文件：

```python
# MiniApp 域名：優先使用 Telegram 認證
miniapp_hosts = [
    "mini.usdt2026.cc",
    "your-new-miniapp-domain.com",  # 添加新域名
    "localhost:5173",
]

# Admin/Web 域名：只使用 JWT Token 認證
web_hosts = [
    "admin.usdt2026.cc",
    "your-new-admin-domain.com",  # 添加新域名
    "localhost:5174",
]
```

## 工作原理

1. **请求检测**: 系统检查请求的 `Host` header 和 `Referer` header
2. **策略选择**: 根据域名匹配选择相应的认证策略
3. **认证执行**: 按照策略定义的顺序尝试认证方式

## 日志记录

系统会记录认证策略选择过程：

```
[Auth Strategy] MiniApp host detected: mini.usdt2026.cc, using telegram_first
[Auth] Strategy for mini.usdt2026.cc: telegram_first
```

## 测试

运行测试脚本验证配置：

```bash
cd /opt/luckyred
python3 scripts/py/test_auth_strategy.py
```

## 注意事项

1. **域名匹配**: 系统使用部分匹配，例如 `mini.usdt2026.cc:443` 也会匹配 `mini.usdt2026.cc`
2. **优先级**: `Host` header 优先于 `Referer` header
3. **默认策略**: 如果域名不匹配任何配置，使用 `both` 策略

## 示例场景

### 场景 1: MiniApp 用户访问
- **请求来源**: `mini.usdt2026.cc`
- **策略**: `telegram_first`
- **认证流程**:
  1. 检查 Telegram `initData`
  2. 如果有 `initData`，使用 Telegram 认证
  3. 如果没有 `initData` 或认证失败，尝试 JWT Token

### 场景 2: Web 管理后台访问
- **请求来源**: `admin.usdt2026.cc`
- **策略**: `jwt_only`
- **认证流程**:
  1. 只检查 JWT Token
  2. 如果没有 JWT Token 或验证失败，返回 401 错误

### 场景 3: 未知域名访问
- **请求来源**: `example.com`
- **策略**: `both`
- **认证流程**:
  1. 优先检查 JWT Token
  2. 如果 JWT 失败，尝试 Telegram `initData`

