# ğŸš€ Lucky Red éƒ¨ç½²è¿ç»´æ–‡æ¡£

## ğŸ“‹ ç›®å½•

- [æœåŠ¡å™¨è¦æ±‚](#æœåŠ¡å™¨è¦æ±‚)
- [å¿«é€Ÿéƒ¨ç½²](#å¿«é€Ÿéƒ¨ç½²)
- [æœåŠ¡ç®¡ç†](#æœåŠ¡ç®¡ç†)
- [ç›‘æ§å’Œæ—¥å¿—](#ç›‘æ§å’Œæ—¥å¿—)
- [æ•…éšœæ’æŸ¥](#æ•…éšœæ’æŸ¥)
- [å¤‡ä»½å’Œæ¢å¤](#å¤‡ä»½å’Œæ¢å¤)

---

## ğŸ–¥ï¸ æœåŠ¡å™¨è¦æ±‚

### æœ€ä½é…ç½®

- **CPU**: 2 æ ¸
- **å†…å­˜**: 4GB
- **å­˜å‚¨**: 20GB
- **æ“ä½œç³»ç»Ÿ**: Ubuntu 22.04 LTS

### æ¨èé…ç½®

- **CPU**: 4 æ ¸
- **å†…å­˜**: 8GB
- **å­˜å‚¨**: 50GB SSD
- **æ“ä½œç³»ç»Ÿ**: Ubuntu 22.04 LTS

### å¿…éœ€è½¯ä»¶

- Python 3.11+
- Node.js 18+
- PostgreSQL 14+
- Nginx
- Redis (å¯é€‰ï¼Œç”¨äºé«˜å¹¶å‘)
- Git

---

## ğŸš€ å¿«é€Ÿéƒ¨ç½²

### 1. å…‹éš†ä»£ç 

```bash
cd /opt
git clone https://github.com/victor2025PH/hoongbao1127.git luckyred
cd luckyred
```

### 2. é…ç½®ç¯å¢ƒå˜é‡

```bash
cp .env.example .env
nano .env
```

**å¿…éœ€é…ç½®é¡¹**:
```env
# Telegram Bot
BOT_TOKEN=your_bot_token_here
ADMIN_IDS=123456789

# Database
DATABASE_URL=postgresql://user:password@localhost:5432/luckyred

# JWT
JWT_SECRET=your_secret_key_here

# Domains
MINIAPP_DOMAIN=mini.usdt2026.cc
ADMIN_DOMAIN=admin.usdt2026.cc
API_BASE_URL=https://api.usdt2026.cc
```

### 3. å®‰è£…ä¾èµ–

```bash
# API ä¾èµ–
cd api
python3 -m venv .venv
source .venv/bin/activate
pip install -r requirements.txt
deactivate
cd ..

# Bot ä¾èµ–
cd bot
python3 -m venv .venv
source .venv/bin/activate
pip install -r requirements.txt
deactivate
cd ..

# Frontend ä¾èµ–
cd frontend
npm install
npm run build
cd ..
```

### 4. é…ç½®æ•°æ®åº“

```bash
# åˆ›å»ºæ•°æ®åº“
sudo -u postgres psql
CREATE DATABASE luckyred;
CREATE USER luckyred WITH PASSWORD 'your_password';
GRANT ALL PRIVILEGES ON DATABASE luckyred TO luckyred;
\q

# è¿è¡Œè¿ç§»ï¼ˆå¦‚æœæœ‰ï¼‰
python3 migrations/init_db.py
```

### 5. é…ç½® Nginx

```bash
# å¤åˆ¶é…ç½®æ–‡ä»¶
sudo cp deploy/nginx/*.conf /etc/nginx/sites-available/

# åˆ›å»ºç¬¦å·é“¾æ¥
sudo ln -s /etc/nginx/sites-available/mini.usdt2026.cc.conf /etc/nginx/sites-enabled/
sudo ln -s /etc/nginx/sites-available/admin.usdt2026.cc.conf /etc/nginx/sites-enabled/

# æµ‹è¯•é…ç½®
sudo nginx -t

# é‡æ–°åŠ è½½
sudo systemctl reload nginx
```

### 6. é…ç½® Systemd æœåŠ¡

```bash
# å¤åˆ¶æœåŠ¡æ–‡ä»¶
sudo cp deploy/systemd/*.service /etc/systemd/system/

# é‡æ–°åŠ è½½ systemd
sudo systemctl daemon-reload

# å¯åŠ¨æœåŠ¡
sudo systemctl enable luckyred-api luckyred-bot
sudo systemctl start luckyred-api luckyred-bot
```

### 7. è·å– SSL è¯ä¹¦

```bash
sudo certbot --nginx -d mini.usdt2026.cc -d admin.usdt2026.cc
```

---

## ğŸ”§ æœåŠ¡ç®¡ç†

### ä½¿ç”¨éƒ¨ç½²è„šæœ¬ï¼ˆæ¨èï¼‰

```bash
# æ‹‰å–æœ€æ–°ä»£ç å¹¶éƒ¨ç½²
cd /opt/luckyred
bash scripts/sh/pull-and-deploy.sh
```

### æ‰‹åŠ¨ç®¡ç†æœåŠ¡

```bash
# å¯åŠ¨æœåŠ¡
sudo systemctl start luckyred-api
sudo systemctl start luckyred-bot

# åœæ­¢æœåŠ¡
sudo systemctl stop luckyred-api
sudo systemctl stop luckyred-bot

# é‡å¯æœåŠ¡
sudo systemctl restart luckyred-api
sudo systemctl restart luckyred-bot

# æŸ¥çœ‹çŠ¶æ€
sudo systemctl status luckyred-api
sudo systemctl status luckyred-bot

# æŸ¥çœ‹æ—¥å¿—
sudo journalctl -u luckyred-api -f
sudo journalctl -u luckyred-bot -f
```

### é‡æ–°åŠ è½½é…ç½®

```bash
# é‡æ–°åŠ è½½ Nginx
sudo systemctl reload nginx

# é‡æ–°åŠ è½½ systemd é…ç½®
sudo systemctl daemon-reload
sudo systemctl restart luckyred-api luckyred-bot
```

---

## ğŸ“Š ç›‘æ§å’Œæ—¥å¿—

### å¥åº·æ£€æŸ¥

```bash
# åŸºç¡€å¥åº·æ£€æŸ¥
curl http://localhost:8080/health

# è¯¦ç»†å¥åº·æ£€æŸ¥
curl http://localhost:8080/health/detailed

# ç³»ç»ŸæŒ‡æ ‡
curl http://localhost:8080/health/metrics
```

### æ—¥å¿—æŸ¥çœ‹

```bash
# API æ—¥å¿—
sudo journalctl -u luckyred-api -f
sudo journalctl -u luckyred-api -n 100

# Bot æ—¥å¿—
sudo journalctl -u luckyred-bot -f
sudo journalctl -u luckyred-bot -n 100

# Nginx æ—¥å¿—
sudo tail -f /var/log/nginx/access.log
sudo tail -f /var/log/nginx/error.log
```

### æ€§èƒ½ç›‘æ§

ç›‘æ§ä¸­é—´ä»¶ä¼šè‡ªåŠ¨è®°å½•ï¼š
- è¯·æ±‚æ–¹æ³•ã€è·¯å¾„ã€IP
- å“åº”çŠ¶æ€ç 
- å¤„ç†æ—¶é—´ï¼ˆX-Process-Time å“åº”å¤´ï¼‰

æŸ¥çœ‹æ€§èƒ½æŒ‡æ ‡ï¼š
```bash
# æŸ¥çœ‹æœ€è¿‘çš„æ…¢è¯·æ±‚ï¼ˆ>1ç§’ï¼‰
sudo journalctl -u luckyred-api | grep -E "Process-Time.*[1-9]\.[0-9]+s"
```

---

## ğŸ” æ•…éšœæ’æŸ¥

### æœåŠ¡æ— æ³•å¯åŠ¨

```bash
# æ£€æŸ¥æœåŠ¡çŠ¶æ€
sudo systemctl status luckyred-api

# æŸ¥çœ‹è¯¦ç»†é”™è¯¯
sudo journalctl -u luckyred-api -n 50

# æ£€æŸ¥ç«¯å£å ç”¨
sudo netstat -tlnp | grep 8080

# æ£€æŸ¥é…ç½®æ–‡ä»¶
python3 -m api.main --check-config
```

### æ•°æ®åº“è¿æ¥å¤±è´¥

```bash
# æµ‹è¯•æ•°æ®åº“è¿æ¥
psql -h localhost -U luckyred -d luckyred

# æ£€æŸ¥æ•°æ®åº“æœåŠ¡
sudo systemctl status postgresql

# æ£€æŸ¥è¿æ¥æ•°
sudo -u postgres psql -c "SELECT count(*) FROM pg_stat_activity;"
```

### Nginx 502 é”™è¯¯

```bash
# æ£€æŸ¥ API æœåŠ¡æ˜¯å¦è¿è¡Œ
curl http://localhost:8080/health

# æ£€æŸ¥ Nginx é…ç½®
sudo nginx -t

# æŸ¥çœ‹ Nginx é”™è¯¯æ—¥å¿—
sudo tail -f /var/log/nginx/error.log
```

### å‰ç«¯æ— æ³•è®¿é—®

```bash
# æ£€æŸ¥å‰ç«¯æ–‡ä»¶
ls -la /opt/luckyred/frontend/dist/

# æ£€æŸ¥ Nginx é…ç½®
sudo nginx -t

# æ£€æŸ¥æ–‡ä»¶æƒé™
sudo chown -R www-data:www-data /opt/luckyred/frontend/dist
```

### ä½¿ç”¨éƒ¨ç½²æµ‹è¯•è„šæœ¬

```bash
# è¿è¡Œå®Œæ•´æµ‹è¯•
bash scripts/sh/test-deployment.sh

# æµ‹è¯•ç»“æœä¼šæ˜¾ç¤ºï¼š
# - Git ä»“åº“çŠ¶æ€
# - ç›®å½•ç»“æ„
# - ä¾èµ–æ–‡ä»¶
# - è™šæ‹Ÿç¯å¢ƒ
# - æœåŠ¡çŠ¶æ€
# - API å¥åº·æ£€æŸ¥
# - ç«¯å£ç›‘å¬
# - ç¯å¢ƒå˜é‡
```

---

## ğŸ’¾ å¤‡ä»½å’Œæ¢å¤

### æ•°æ®åº“å¤‡ä»½

```bash
# åˆ›å»ºå¤‡ä»½
sudo -u postgres pg_dump luckyred > backup_$(date +%Y%m%d).sql

# æ¢å¤å¤‡ä»½
sudo -u postgres psql luckyred < backup_20251206.sql
```

### ä»£ç å¤‡ä»½

```bash
# åˆ›å»ºä»£ç å¿«ç…§
cd /opt
tar -czf luckyred_backup_$(date +%Y%m%d).tar.gz luckyred
```

### è‡ªåŠ¨å¤‡ä»½è„šæœ¬

```bash
# åˆ›å»ºå¤‡ä»½è„šæœ¬
cat > /opt/backup.sh << 'EOF'
#!/bin/bash
BACKUP_DIR="/opt/backups"
DATE=$(date +%Y%m%d)

# åˆ›å»ºå¤‡ä»½ç›®å½•
mkdir -p $BACKUP_DIR

# å¤‡ä»½æ•°æ®åº“
sudo -u postgres pg_dump luckyred > $BACKUP_DIR/db_$DATE.sql

# å¤‡ä»½ä»£ç 
tar -czf $BACKUP_DIR/code_$DATE.tar.gz /opt/luckyred

# åˆ é™¤7å¤©å‰çš„å¤‡ä»½
find $BACKUP_DIR -name "*.sql" -mtime +7 -delete
find $BACKUP_DIR -name "*.tar.gz" -mtime +7 -delete
EOF

chmod +x /opt/backup.sh

# æ·»åŠ åˆ° crontabï¼ˆæ¯å¤©å‡Œæ™¨2ç‚¹å¤‡ä»½ï¼‰
(crontab -l 2>/dev/null; echo "0 2 * * * /opt/backup.sh") | crontab -
```

---

## ğŸ”„ æ›´æ–°éƒ¨ç½²

### ä½¿ç”¨ä¸€é”®éƒ¨ç½²è„šæœ¬

```bash
cd /opt/luckyred
bash scripts/sh/pull-and-deploy.sh
```

### æ‰‹åŠ¨æ›´æ–°

```bash
# 1. æ‹‰å–æœ€æ–°ä»£ç 
cd /opt/luckyred
git stash
git pull origin master

# 2. å®‰è£…ä¾èµ–
cd api && source .venv/bin/activate && pip install -r requirements.txt && deactivate && cd ..
cd bot && source .venv/bin/activate && pip install -r requirements.txt && deactivate && cd ..
cd frontend && npm install && npm run build && cd ..

# 3. é‡å¯æœåŠ¡
sudo systemctl restart luckyred-api luckyred-bot
sudo systemctl reload nginx
```

---

## ğŸ“ ç»´æŠ¤æ£€æŸ¥æ¸…å•

### æ¯æ—¥æ£€æŸ¥

- [ ] æœåŠ¡è¿è¡ŒçŠ¶æ€
- [ ] é”™è¯¯æ—¥å¿—
- [ ] ç£ç›˜ç©ºé—´
- [ ] å†…å­˜ä½¿ç”¨

### æ¯å‘¨æ£€æŸ¥

- [ ] æ•°æ®åº“å¤§å°
- [ ] å¤‡ä»½å®Œæ•´æ€§
- [ ] SSL è¯ä¹¦æœ‰æ•ˆæœŸ
- [ ] ç³»ç»Ÿæ›´æ–°

### æ¯æœˆæ£€æŸ¥

- [ ] æ€§èƒ½æŒ‡æ ‡åˆ†æ
- [ ] æ—¥å¿—æ¸…ç†
- [ ] å®‰å…¨æ›´æ–°
- [ ] å®¹é‡è§„åˆ’

---

## ğŸ”— ç›¸å…³æ–‡æ¡£

- [ç”¨æˆ·ä½¿ç”¨æŒ‡å—](./ç”¨æˆ·ä½¿ç”¨æŒ‡å—.md)
- [API æ¥å£æ–‡æ¡£](./APIæ¥å£æ–‡æ¡£.md)
- [éƒ¨ç½²è„šæœ¬è¯´æ˜](../scripts/sh/README.md)

---

## ğŸ“ æŠ€æœ¯æ”¯æŒ

å¦‚é‡åˆ°é—®é¢˜ï¼Œè¯·ï¼š
1. æŸ¥çœ‹æ—¥å¿—æ–‡ä»¶
2. è¿è¡Œéƒ¨ç½²æµ‹è¯•è„šæœ¬
3. æ£€æŸ¥æœåŠ¡çŠ¶æ€
4. è”ç³»æŠ€æœ¯æ”¯æŒå›¢é˜Ÿ

