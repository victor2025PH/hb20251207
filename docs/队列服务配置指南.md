# 📬 队列服务配置指南

## 概述

队列服务用于异步处理任务，特别是Redis抢红包结果的同步到PostgreSQL。

支持三种模式：
1. **BullMQ**（推荐）- 基于Redis的现代队列
2. **Celery** - 成熟的Python任务队列
3. **内存队列**（开发模式）- 仅用于开发，数据不持久化

---

## BullMQ配置（推荐）

### 1. 安装依赖

```bash
pip install bullmq
```

### 2. 启动Worker

```bash
# 方式1: 使用Python脚本
python api/workers/start_worker.py --type bullmq

# 方式2: 使用systemd服务（生产环境）
# 创建 /etc/systemd/system/luckyred-worker.service
```

### 3. systemd服务配置示例

```ini
[Unit]
Description=Lucky Red Queue Worker
After=network.target redis.service

[Service]
Type=simple
User=www-data
WorkingDirectory=/opt/luckyred
Environment="PATH=/opt/luckyred/.venv/bin"
ExecStart=/opt/luckyred/.venv/bin/python api/workers/start_worker.py --type bullmq
Restart=always

[Install]
WantedBy=multi-user.target
```

---

## Celery配置

### 1. 安装依赖

```bash
pip install celery redis
```

### 2. 启动Worker

```bash
celery -A api.services.queue_workers worker --loglevel=info
```

### 3. 启动Flower（监控，可选）

```bash
celery -A api.services.queue_workers flower
```

访问 http://localhost:5555 查看任务状态

---

## 内存队列（开发模式）

如果BullMQ和Celery都不可用，系统会自动使用内存队列：
- ✅ 无需配置
- ⚠️ 数据不持久化
- ⚠️ 仅用于开发

---

## 任务类型

### 账本同步任务

当Redis抢红包成功后，会自动将同步任务加入队列：

```python
{
    'packet_uuid': '...',
    'user_id': 123,
    'claim_id': '...',
    'amount': 10.5,
    'currency': 'USDT',
    'packet_status': {...}
}
```

Worker会：
1. 创建领取记录
2. 更新红包状态
3. 使用LedgerService更新余额

---

## 监控和调试

### BullMQ

```bash
# 查看队列状态（需要Redis CLI）
redis-cli
> LLEN bull:ledger-sync:wait
> LLEN bull:ledger-sync:active
> LLEN bull:ledger-sync:completed
```

### Celery

```bash
# 查看任务状态
celery -A api.services.queue_workers inspect active
celery -A api.services.queue_workers inspect stats
```

---

## 生产环境建议

1. **使用BullMQ**（更现代，性能更好）
2. **配置systemd服务**（自动重启）
3. **监控队列长度**（防止积压）
4. **设置任务超时**（防止死锁）
5. **实现重试机制**（处理临时失败）

---

## 故障排查

### Worker未启动

```bash
# 检查Redis连接
redis-cli ping

# 检查Python依赖
pip list | grep -E "bullmq|celery"
```

### 任务未处理

1. 检查Worker是否运行
2. 检查Redis连接
3. 查看日志文件
4. 检查任务格式是否正确

---

## 性能优化

1. **批量处理**：一次处理多个任务
2. **并发Worker**：启动多个Worker进程
3. **优先级队列**：重要任务优先处理
4. **任务去重**：防止重复处理

