# 下一步行动计划 - 认证策略验证

## 当前状态

✅ **已完成**:
- 基于请求来源的认证策略选择功能
- WebSocket 连接改进和异常处理
- Nginx WebSocket 代理配置
- 认证策略测试脚本和文档

## 立即行动

### 1. 在服务器上验证认证策略

```bash
cd /opt/luckyred

# 拉取最新代码
git pull origin master

# 重启 API 服务
sudo systemctl restart luckyred-api

# 运行认证策略测试
python3 scripts/py/test_auth_strategy.py
```

### 2. 测试不同端口的认证行为

#### 测试 MiniApp 端口 (`mini.usdt2026.cc`)
1. 在浏览器中访问 `https://mini.usdt2026.cc`
2. 检查控制台日志，应该看到：
   - `[Auth Strategy] MiniApp host detected: mini.usdt2026.cc, using telegram_first`
   - 优先尝试 Telegram 认证
   - 如果没有 `initData`，回退到 JWT Token

#### 测试 Admin 端口 (`admin.usdt2026.cc`)
1. 在浏览器中访问 `https://admin.usdt2026.cc`
2. 检查控制台日志，应该看到：
   - `[Auth Strategy] Web host detected: admin.usdt2026.cc, using jwt_only`
   - 只使用 JWT Token 认证
   - 不接受 Telegram `initData`

### 3. 验证 WebSocket 连接稳定性

1. 使用 Google 登录
2. 观察控制台，应该看到：
   - `[WebSocket] Using JWT token for authentication.`
   - `[WebSocket] Connected`
   - 连接保持稳定，不再频繁断开重连

### 4. 检查服务器日志

```bash
# 查看认证策略选择日志
sudo journalctl -u luckyred-api -f | grep -i "auth strategy\|auth.*strategy"

# 查看 WebSocket 连接日志
sudo journalctl -u luckyred-api -f | grep -i websocket
```

## 功能验证清单

- [ ] 认证策略测试脚本运行通过
- [ ] MiniApp 端口优先使用 Telegram 认证
- [ ] Admin 端口只使用 JWT Token 认证
- [ ] WebSocket 连接稳定，不再频繁断开
- [ ] 所有 API 端点正常工作
- [ ] 用户登录流程正常

## 如果发现问题

### 问题 1: 认证策略选择不正确
- 检查 `api/utils/auth_strategy.py` 中的域名配置
- 查看服务器日志中的策略选择记录

### 问题 2: WebSocket 仍然断开
- 检查服务器日志中的 WebSocket 错误
- 验证 Nginx WebSocket 代理配置
- 检查 JWT Token 是否有效

### 问题 3: API 端点返回 401
- 检查认证策略是否正确应用
- 验证 JWT Token 或 Telegram initData 是否正确传递
- 查看服务器日志中的认证错误

## 后续优化建议

1. **性能优化**
   - 添加认证结果缓存（Redis）
   - 优化数据库查询

2. **安全加固**
   - 添加请求频率限制
   - 实现 IP 白名单功能

3. **监控和告警**
   - 添加认证失败率监控
   - 设置异常连接告警

4. **用户体验**
   - 优化登录流程
   - 添加登录状态持久化

## 相关文档

- `docs/认证策略配置说明.md` - 详细的配置说明
- `scripts/py/test_auth_strategy.py` - 认证策略测试脚本

