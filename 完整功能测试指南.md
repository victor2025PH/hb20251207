# 🧪 完整功能测试指南

## 📋 测试清单

### 1. ✅ Universal Identity System测试

#### 运行测试脚本
```bash
python scripts/py/test_identity_system.py
```

#### 测试项目
- [x] 通过Telegram ID创建用户
- [x] 通过Google创建用户（tg_id为None）
- [x] 通过Wallet创建用户
- [x] 链接Wallet到Telegram用户
- [x] 生成Magic Link
- [x] 验证Magic Link
- [x] 获取用户所有身份

---

### 2. ✅ LedgerService测试

#### 运行测试脚本
```bash
python scripts/py/test_identity_system.py
```

#### 测试项目
- [x] 创建账本条目（增加余额）
- [x] 获取余额
- [x] 创建账本条目（减少余额）
- [x] 获取所有余额
- [x] 获取账本历史

**注意**: 需要redis模块（可选），如果不可用会回退到数据库模式

---

### 3. ✅ Redis高并发抢红包测试

#### 运行测试脚本
```bash
python scripts/py/test_redis_claim.py
```

#### 测试项目
- [x] 初始化红包到Redis
- [x] 获取红包状态
- [x] 抢红包（单个用户）
- [x] 重复领取检查
- [x] 并发抢红包（10个用户同时抢）

**要求**: 需要Redis服务运行（`redis-server`）

---

### 4. ✅ PaymentService测试

#### 运行测试脚本
```bash
python scripts/py/test_payment_service.py
```

#### 测试项目
- [x] 获取汇率（CNY -> USDT，含利润点）
- [x] 法币支付（UnionPay Mock）
- [x] 加密货币充值（Mock）
- [x] 提现（Mock）

---

### 5. ✅ Auth API测试

#### 运行测试脚本
```bash
# 需要先启动API服务
uvicorn api.main:app --reload

# 然后在另一个终端运行
python scripts/py/test_auth_api.py
```

#### 测试项目
- [x] Google OAuth登录（Mock）
- [x] Wallet连接（Mock）
- [x] Magic Link生成（需要Telegram认证）
- [x] Magic Link验证

---

## 🔧 环境要求

### 必需
- Python 3.8+
- SQLite或PostgreSQL数据库
- FastAPI服务运行

### 可选（用于高并发和缓存）
- Redis服务器（用于高并发抢红包）
- redis Python包（`pip install redis`）

---

## 🚀 快速测试流程

### 1. 测试IdentityService
```bash
cd C:\hbgm001
python scripts/py/test_identity_system.py
```

### 2. 测试PaymentService
```bash
python scripts/py/test_payment_service.py
```

### 3. 测试Redis抢红包（需要Redis）
```bash
# 启动Redis（如果未运行）
redis-server

# 运行测试
python scripts/py/test_redis_claim.py
```

### 4. 测试Auth API（需要API服务）
```bash
# 终端1: 启动API
uvicorn api.main:app --reload --port 8080

# 终端2: 运行测试
python scripts/py/test_auth_api.py
```

---

## 📊 预期结果

### IdentityService测试
- ✅ 所有测试应该通过
- ✅ 用户创建成功，UUID生成
- ✅ 身份链接成功
- ✅ Magic Link生成和验证成功

### LedgerService测试
- ✅ 账本条目创建成功
- ✅ 余额更新正确
- ✅ 账本历史查询成功

### Redis抢红包测试
- ✅ 红包初始化成功
- ✅ 抢红包成功
- ✅ 重复领取被阻止
- ✅ 并发测试：10个用户应该都能成功领取（如果红包有10个）

### PaymentService测试
- ✅ 汇率计算正确（含利润点）
- ✅ 法币支付成功，自动转换为USDT
- ✅ 加密货币充值成功
- ✅ 提现成功

---

## ⚠️ 已知问题

1. **Redis模块缺失**
   - 问题: `ModuleNotFoundError: No module named 'redis'`
   - 解决: `pip install redis`（可选，系统会回退到数据库模式）

2. **User模型tg_id字段**
   - 已修复: tg_id现在允许为None，支持非Telegram用户

3. **Google OAuth和Wallet验证**
   - 目前是Mock版本，生产环境需要实现真实验证

---

## 🎯 下一步测试

1. **集成测试**
   - 测试完整的支付流程（法币支付 -> 充值 -> 发送红包 -> 抢红包）
   - 测试跨平台登录流程（Telegram -> Magic Link -> Web登录）

2. **压力测试**
   - 测试10k+并发抢红包
   - 测试Redis性能

3. **端到端测试**
   - 前端 + 后端完整流程测试
   - 真实Telegram环境测试

---

## 📝 测试报告

所有测试脚本已创建，可以运行测试验证功能。

测试结果将显示：
- ✅ 成功的功能
- ❌ 失败的功能
- ⚠️ 需要修复的问题

