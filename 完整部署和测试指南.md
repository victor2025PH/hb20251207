# 🚀 任务红包系统 - 完整部署和测试指南

## 📋 部署步骤

### 方法1：一键部署和测试（推荐）

SSH到服务器后执行：

```bash
cd /opt/luckyred
git pull origin master
bash scripts/sh/full-deploy-and-test.sh
```

这个脚本会自动完成：
1. ✅ 拉取最新代码
2. ✅ 运行数据库迁移
3. ✅ 安装API依赖
4. ✅ 构建前端
5. ✅ 重启服务
6. ✅ 检查服务状态
7. ✅ 测试API路由
8. ✅ 检查前端文件
9. ✅ 检查数据库表
10. ✅ 检查Nginx配置

### 方法2：分步部署

```bash
# 1. SSH到服务器
ssh user@your-server

# 2. 进入项目目录
cd /opt/luckyred

# 3. 拉取最新代码
git pull origin master

# 4. 运行数据库迁移
python3 migrations/add_task_redpacket_system.py

# 5. 安装API依赖
cd /opt/luckyred/api
source .venv/bin/activate
pip install -r requirements.txt

# 6. 构建前端
cd /opt/luckyred/frontend
npm install
npm run build

# 7. 重启服务
sudo systemctl restart luckyred-api
sudo systemctl restart luckyred-bot

# 8. 运行测试
python3 scripts/py/test_tasks_api.py
```

## 🧪 功能测试清单

### 1. 前端测试

访问以下URL检查页面是否正常加载：

- ✅ `https://mini.usdt2026.cc/tasks` - 任务页面
- ✅ `https://mini.usdt2026.cc/packets` - 红包列表
- ✅ `https://mini.usdt2026.cc/` - 钱包页面

### 2. API测试

在服务器上执行：

```bash
# 测试任务API（需要认证，返回401是正常的）
curl -X GET http://localhost:8080/api/v1/tasks/status

# 测试分享API
curl -X POST http://localhost:8080/api/v1/share/record

# 测试推荐红包API
curl -X GET http://localhost:8080/api/v1/redpackets/recommended
```

### 3. 功能测试

#### 3.1 签到任务测试

1. 打开MiniApp
2. 进入签到页面
3. 完成签到
4. 进入任务页面 (`/tasks`)
5. 检查"每日签到"任务是否显示为"已完成"
6. 点击"领取"按钮
7. 检查是否成功领取任务红包

#### 3.2 抢红包任务测试

1. 打开红包列表页面
2. 领取一个红包
3. 进入任务页面
4. 检查"抢红包"任务是否显示为"已完成"
5. 点击"领取"按钮
6. 检查是否成功领取任务红包

#### 3.3 发红包任务测试

1. 打开发红包页面
2. 发送一个红包
3. 进入任务页面
4. 检查"发红包"任务是否显示为"已完成"
5. 点击"领取"按钮
6. 检查是否成功领取任务红包

#### 3.4 邀请任务测试

1. 通过邀请链接邀请一个新用户
2. 新用户完成注册
3. 邀请人进入任务页面
4. 检查"邀请好友"任务是否显示为"已完成"
5. 点击"领取"按钮
6. 检查是否成功领取任务红包

#### 3.5 分享任务测试

1. 调用分享API或点击分享按钮
2. 进入任务页面
3. 检查"分享应用"任务是否显示为"已完成"
4. 点击"领取"按钮
5. 检查是否成功领取任务红包

#### 3.6 成就任务测试

1. 完成5个邀请 → 检查"邀请达人"任务
2. 完成10个邀请 → 检查"邀请大师"任务
3. 领取10个红包 → 检查"抢包达人"任务
4. 发送10个红包 → 检查"发包达人"任务
5. 连续签到7天 → 检查"签到达人"任务

#### 3.7 推荐红包测试

1. 访问红包列表页面
2. 检查是否显示推荐红包
3. 新用户应该优先看到任务红包
4. 活跃用户应该优先看到高价值红包

## 🔍 问题排查

### 问题1: 任务页面无法访问

**检查：**
```bash
# 检查前端文件是否存在
ls -la /opt/luckyred/frontend/dist/

# 检查Nginx配置
nginx -t
sudo systemctl status nginx

# 检查前端路由配置
grep -r "tasks" /opt/luckyred/frontend/src/App.tsx
```

### 问题2: 任务不自动完成

**检查：**
```bash
# 查看API日志
sudo journalctl -u luckyred-api -f

# 检查任务完成标记函数
grep -r "mark_task_complete" /opt/luckyred/api/routers/

# 检查数据库表
python3 scripts/py/test_tasks_api.py
```

### 问题3: 数据库迁移失败

**检查：**
```bash
# 手动运行迁移
python3 migrations/add_task_redpacket_system.py

# 检查数据库连接
python3 -c "from shared.database.connection import sync_engine; print(sync_engine.url)"
```

### 问题4: 前端构建失败

**检查：**
```bash
# 检查Node.js版本
node -v
npm -v

# 清理并重新安装
cd /opt/luckyred/frontend
rm -rf node_modules package-lock.json
npm install
npm run build
```

## 📊 验证清单

部署完成后，确认以下项目：

- [ ] 代码已更新到最新版本
- [ ] 数据库迁移已成功执行
- [ ] 前端已成功构建
- [ ] API服务正常运行
- [ ] Bot服务正常运行
- [ ] 任务页面可以访问
- [ ] 任务API可以调用
- [ ] 数据库表已创建
- [ ] 数据库字段已添加
- [ ] Nginx配置正确

## 📝 日志查看

```bash
# API服务日志
sudo journalctl -u luckyred-api -f

# Bot服务日志
sudo journalctl -u luckyred-bot -f

# Nginx日志
sudo tail -f /var/log/nginx/error.log
sudo tail -f /var/log/nginx/access.log
```

## 🎉 完成

部署和测试完成后，所有功能应该正常工作。如果遇到问题，请查看日志并按照问题排查步骤进行修复。

