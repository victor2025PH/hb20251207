# ğŸ—„ï¸ æ•°æ®åº“ä¿®å¤å®Œæ•´æŒ‡å—

## å½“å‰é—®é¢˜

**é”™è¯¯**: `column "uuid" of relation "users" does not exist`

**åŸå› **: æ•°æ®åº“è¡¨æ˜¯æ—§ç‰ˆæœ¬åˆ›å»ºçš„ï¼Œç¼ºå°‘æ–°æ·»åŠ çš„åˆ—ï¼ˆ`uuid`, `wallet_address`, `wallet_network`, `primary_platform` ç­‰ï¼‰

## å¿«é€Ÿä¿®å¤ï¼ˆæ¨èï¼‰

### æ–¹æ³• 1: ä½¿ç”¨ä¿®å¤è„šæœ¬

```bash
cd /opt/luckyred
git pull origin master
bash fix-database.sh
```

### æ–¹æ³• 2: æ‰‹åŠ¨æ‰§è¡Œ

```bash
cd /opt/luckyred

# 1. æ‹‰å–æœ€æ–°ä»£ç 
git pull origin master

# 2. è¿è¡Œæ•°æ®åº“è¿ç§»
cd api
source .venv/bin/activate
python3 ../scripts/py/migrate_add_uuid_column.py

# 3. å¦‚æœè¿ç§»è„šæœ¬å¤±è´¥ï¼Œä½¿ç”¨ init_db
python3 << 'EOF'
import sys
sys.path.insert(0, '/opt/luckyred')
from shared.database.connection import init_db
init_db()
print("âœ… æ•°æ®åº“è¡¨å·²æ›´æ–°")
EOF

# 4. é‡æ–°æ„å»ºå‰ç«¯
cd ../frontend
npm run build

# 5. é‡å¯æœåŠ¡
sudo systemctl restart luckyred-api
sudo systemctl reload nginx
```

## æ£€æŸ¥æ•°æ®åº“è¡¨ç»“æ„

è¿è¡Œæ£€æŸ¥è„šæœ¬ï¼š

```bash
cd /opt/luckyred
bash check-database.sh
```

## æ‰‹åŠ¨æ£€æŸ¥ï¼ˆPostgreSQLï¼‰

```bash
# è¿æ¥åˆ°æ•°æ®åº“
psql -U your_user -d your_db

# æ£€æŸ¥ users è¡¨ç»“æ„
\d users

# æ£€æŸ¥æ˜¯å¦æœ‰ uuid åˆ—
SELECT column_name, data_type 
FROM information_schema.columns 
WHERE table_name = 'users' AND column_name = 'uuid';

# å¦‚æœæ²¡æœ‰ï¼Œæ·»åŠ åˆ—
ALTER TABLE users ADD COLUMN uuid VARCHAR(36) UNIQUE;
CREATE INDEX IF NOT EXISTS ix_users_uuid ON users(uuid);
```

## æ‰‹åŠ¨æ£€æŸ¥ï¼ˆSQLiteï¼‰

```bash
# æŸ¥çœ‹è¡¨ç»“æ„
sqlite3 your_db.db ".schema users"

# å¦‚æœç¼ºå°‘åˆ—ï¼Œä½¿ç”¨ init_db é‡å»ºè¡¨
cd /opt/luckyred/api
source .venv/bin/activate
python3 -c "from shared.database.connection import init_db; init_db()"
```

## éœ€è¦æ·»åŠ çš„åˆ—

æ ¹æ®æ¨¡å‹å®šä¹‰ï¼Œ`users` è¡¨éœ€è¦ä»¥ä¸‹åˆ—ï¼š

1. `uuid` - VARCHAR(36), UNIQUE, nullable
2. `wallet_address` - VARCHAR(255), nullable
3. `wallet_network` - VARCHAR(50), nullable
4. `referrer_id` - INTEGER, nullable (å¤–é”®)
5. `referral_code` - VARCHAR(20), UNIQUE, nullable
6. `total_referrals` - INTEGER, default 0
7. `tier1_commission` - NUMERIC(5,2), default 0.10
8. `tier2_commission` - NUMERIC(5,2), default 0.05
9. `primary_platform` - VARCHAR(20), nullable
10. `last_active_at` - DATETIME, nullable
11. `kyc_status` - VARCHAR(20), default 'pending'
12. `kyc_verified_at` - DATETIME, nullable

## å®Œæ•´è¿ç§» SQLï¼ˆPostgreSQLï¼‰

å¦‚æœæ‰‹åŠ¨ä¿®å¤ï¼Œå¯ä»¥è¿è¡Œä»¥ä¸‹ SQLï¼š

```sql
-- æ·»åŠ  uuid åˆ—
ALTER TABLE users ADD COLUMN IF NOT EXISTS uuid VARCHAR(36);
CREATE UNIQUE INDEX IF NOT EXISTS ix_users_uuid ON users(uuid) WHERE uuid IS NOT NULL;

-- æ·»åŠ å…¶ä»–ç¼ºå¤±çš„åˆ—
ALTER TABLE users ADD COLUMN IF NOT EXISTS wallet_address VARCHAR(255);
ALTER TABLE users ADD COLUMN IF NOT EXISTS wallet_network VARCHAR(50);
ALTER TABLE users ADD COLUMN IF NOT EXISTS referrer_id INTEGER REFERENCES users(id);
ALTER TABLE users ADD COLUMN IF NOT EXISTS referral_code VARCHAR(20);
ALTER TABLE users ADD COLUMN IF NOT EXISTS total_referrals INTEGER DEFAULT 0;
ALTER TABLE users ADD COLUMN IF NOT EXISTS tier1_commission NUMERIC(5,2) DEFAULT 0.10;
ALTER TABLE users ADD COLUMN IF NOT EXISTS tier2_commission NUMERIC(5,2) DEFAULT 0.05;
ALTER TABLE users ADD COLUMN IF NOT EXISTS primary_platform VARCHAR(20);
ALTER TABLE users ADD COLUMN IF NOT EXISTS last_active_at TIMESTAMP;
ALTER TABLE users ADD COLUMN IF NOT EXISTS kyc_status VARCHAR(20) DEFAULT 'pending';
ALTER TABLE users ADD COLUMN IF NOT EXISTS kyc_verified_at TIMESTAMP;

-- åˆ›å»ºç´¢å¼•
CREATE UNIQUE INDEX IF NOT EXISTS ix_users_referral_code ON users(referral_code) WHERE referral_code IS NOT NULL;
```

## éªŒè¯ä¿®å¤

ä¿®å¤åï¼Œè¿è¡Œæ£€æŸ¥è„šæœ¬éªŒè¯ï¼š

```bash
bash check-database.sh
```

åº”è¯¥çœ‹åˆ°ï¼š
```
âœ… users è¡¨å­˜åœ¨
âœ… æ‰€æœ‰å¿…éœ€çš„åˆ—éƒ½å­˜åœ¨
âœ… user_identities è¡¨å­˜åœ¨
âœ… account_links è¡¨å­˜åœ¨
âœ… æ•°æ®åº“è¡¨ç»“æ„æ£€æŸ¥é€šè¿‡ï¼
```

## æµ‹è¯•ç™»å½•

ä¿®å¤åï¼Œæµ‹è¯• Google ç™»å½•ï¼š

1. æ¸…é™¤æµè§ˆå™¨ç¼“å­˜
2. è®¿é—® https://mini.usdt2026.cc
3. ç‚¹å‡» "ä½¿ç”¨Googleç™»å½•"
4. åº”è¯¥æˆåŠŸç™»å½•ï¼Œä¸å†å‡ºç° "uuid column does not exist" é”™è¯¯

## å¦‚æœé—®é¢˜ä»ç„¶å­˜åœ¨

1. **æŸ¥çœ‹è¯¦ç»†é”™è¯¯æ—¥å¿—**:
   ```bash
   sudo journalctl -u luckyred-api -n 100 --no-pager | grep -i "error\|uuid\|column"
   ```

2. **æ£€æŸ¥æ•°æ®åº“è¿æ¥**:
   ```bash
   cd /opt/luckyred/api
   source .venv/bin/activate
   python3 -c "
   from shared.database.connection import sync_engine
   from sqlalchemy import inspect
   inspector = inspect(sync_engine)
   print('Tables:', inspector.get_table_names())
   print('Users columns:', [c['name'] for c in inspector.get_columns('users')])
   "
   ```

3. **æ‰‹åŠ¨è¿è¡Œè¿ç§»**:
   ```bash
   cd /opt/luckyred/api
   source .venv/bin/activate
   python3 ../scripts/py/migrate_add_uuid_column.py
   ```

