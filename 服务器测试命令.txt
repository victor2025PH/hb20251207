# 在服务器上直接执行这些命令（不需要脚本文件）

# 1. 更新代码
cd /opt/luckyred
git pull origin master

# 2. 测试任务API（返回401是正常的，需要认证）
curl http://localhost:8080/api/v1/tasks/status

# 3. 检查API服务状态
sudo systemctl status luckyred-api --no-pager | head -10

# 4. 检查数据库表
cd /opt/luckyred/api
source .venv/bin/activate
cd /opt/luckyred
python3 << 'EOF'
import sys
sys.path.insert(0, '.')
from sqlalchemy import inspect
from shared.database.connection import sync_engine

inspector = inspect(sync_engine)
tables = inspector.get_table_names()

print("数据库表检查:")
for table in ['task_completions', 'red_packets', 'users']:
    if table in tables:
        print(f"✓ {table} 存在")
    else:
        print(f"✗ {table} 不存在")

if 'red_packets' in tables:
    columns = [col['name'] for col in inspector.get_columns('red_packets')]
    for field in ['visibility', 'source_type', 'task_type']:
        if field in columns:
            print(f"✓ red_packets.{field} 存在")
        else:
            print(f"✗ red_packets.{field} 不存在")
EOF
deactivate

# 5. 测试模块导入
cd /opt/luckyred/api
source .venv/bin/activate
cd /opt/luckyred
python3 << 'EOF'
import sys
sys.path.insert(0, '.')
from api.routers import tasks
print(f"✓ tasks模块导入成功")
print(f"  每日任务: {len(tasks.DAILY_TASKS)} 个")
print(f"  成就任务: {len(tasks.ACHIEVEMENT_TASKS)} 个")
EOF
deactivate

# 6. 查看API日志（最近20条）
sudo journalctl -u luckyred-api -n 20 --no-pager

