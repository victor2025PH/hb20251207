# ğŸ”§ ç½‘é¡µç«¯å’Œ Telegram MiniApp è®¤è¯ä¿®å¤è¯´æ˜

## ä¿®å¤çš„é—®é¢˜

### 1. ç½‘é¡µç«¯åŠŸèƒ½æœªå®ç° âœ…
**é—®é¢˜**: `/v1/users/me` ç«¯ç‚¹åªæ”¯æŒ Telegram initDataï¼Œä¸æ”¯æŒ JWT Token

**ä¿®å¤**:
- ä¿®æ”¹ `api/routers/users.py` ä¸­çš„ `/me` å’Œ `/me/balance` ç«¯ç‚¹
- æ”¯æŒåŒé‡è®¤è¯ï¼šä¼˜å…ˆä½¿ç”¨ JWT Tokenï¼ˆWeb ç™»å½•ï¼‰ï¼Œå›é€€åˆ° Telegram initData
- ç¡®ä¿ç½‘é¡µç«¯ç”¨æˆ·ç™»å½•åå¯ä»¥æ­£å¸¸è·å–ç”¨æˆ·ä¿¡æ¯å’Œä½™é¢

### 2. Google è®¤è¯å¤±è´¥ âœ…
**é—®é¢˜**: å½“ Google ç™»å½•æ²¡æœ‰æä¾› email æ—¶ï¼Œè®¤è¯å¤±è´¥

**ä¿®å¤**:
- ä¿®æ”¹ `api/routers/auth/web.py` ä¸­çš„ Google è®¤è¯é€»è¾‘
- å½“æ²¡æœ‰ email æ—¶ï¼Œä½¿ç”¨ id_token çš„ SHA256 hash ä½œä¸º provider_user_id
- æ·»åŠ è¯¦ç»†çš„é”™è¯¯æ—¥å¿—

### 3. Telegram MiniApp è®¤è¯é—®é¢˜ âœ…
**é—®é¢˜**: initData è§£æå¯èƒ½å¤±è´¥ï¼Œå¯¼è‡´è®¤è¯ä¸å·¥ä½œ

**ä¿®å¤**:
- æ”¹è¿› `api/utils/telegram_auth.py` ä¸­çš„ initData è§£æé€»è¾‘
- æ·»åŠ  `verify_telegram_init_data` å‡½æ•°ï¼ˆå¯é€‰å¯ç”¨ï¼‰
- æ”¹è¿›é”™è¯¯å¤„ç†å’Œæ—¥å¿—è®°å½•
- ä½¿ç”¨ `keep_blank_values=True` ç¡®ä¿æ­£ç¡®è§£æå‚æ•°

### 4. æ’ç‰ˆé”™ä½ âœ…
**é—®é¢˜**: WebLoginScreen åœ¨ç§»åŠ¨è®¾å¤‡ä¸Šæ’ç‰ˆé”™ä½

**ä¿®å¤**:
- æ·»åŠ å“åº”å¼ CSS æ”¯æŒ
- åœ¨ç§»åŠ¨è®¾å¤‡ä¸Šï¼ˆ< 480pxï¼‰ä½¿ç”¨å•åˆ—å¸ƒå±€
- è°ƒæ•´ padding å’Œ border-radius ä»¥é€‚åº”å°å±å¹•
- æ·»åŠ  `max-height: 90vh` å’Œ `overflow-y: auto` é˜²æ­¢å†…å®¹æº¢å‡º

## ä¿®æ”¹çš„æ–‡ä»¶

### åç«¯
1. `api/routers/users.py`
   - `/me` ç«¯ç‚¹ï¼šæ”¯æŒ JWT Token å’Œ Telegram initData
   - `/me/balance` ç«¯ç‚¹ï¼šæ”¯æŒ JWT Token å’Œ Telegram initData

2. `api/routers/auth/web.py`
   - Google è®¤è¯ï¼šæ”¹è¿› email å¤„ç†é€»è¾‘

3. `api/utils/telegram_auth.py`
   - æ”¹è¿› initData è§£æ
   - æ·»åŠ éªŒè¯å‡½æ•°ï¼ˆå¯é€‰ï¼‰

### å‰ç«¯
1. `frontend/src/components/WebLoginScreen.tsx`
   - æ·»åŠ å“åº”å¼ CSS
   - ä¿®å¤ç§»åŠ¨ç«¯æ’ç‰ˆ

## æœåŠ¡å™¨éƒ¨ç½²æ­¥éª¤

```bash
# 1. è¿›å…¥é¡¹ç›®ç›®å½•
cd /opt/luckyred

# 2. æ‹‰å–æœ€æ–°ä»£ç 
git pull origin master

# 3. å®‰è£…/æ›´æ–° Python ä¾èµ–
cd api
source .venv/bin/activate
pip install -r requirements.txt

# 4. é‡æ–°æ„å»ºå‰ç«¯
cd ../frontend
npm run build

# 5. é‡å¯ API æœåŠ¡
sudo systemctl restart luckyred-api

# 6. é‡æ–°åŠ è½½ Nginx
sudo systemctl reload nginx
```

## éªŒè¯æ­¥éª¤

### 1. ç½‘é¡µç«¯ç™»å½•éªŒè¯

1. **æ¸…é™¤æµè§ˆå™¨ç¼“å­˜**
2. **è®¿é—®**: https://mini.usdt2026.cc
3. **ç‚¹å‡» "ä½¿ç”¨Googleç™»å½•"**
   - åº”è¯¥æˆåŠŸç™»å½•ï¼ˆå³ä½¿æ²¡æœ‰çœŸå®çš„ Google OAuthï¼‰
   - åº”è¯¥æ˜¾ç¤ºç”¨æˆ·ä¿¡æ¯
   - åº”è¯¥å¯ä»¥è®¿é—®æ‰€æœ‰åŠŸèƒ½

### 2. Telegram MiniApp éªŒè¯

1. **åœ¨ Telegram ä¸­æ‰“å¼€ MiniApp**
2. **åº”è¯¥è‡ªåŠ¨ç™»å½•**ï¼ˆå¦‚æœæœ‰ initDataï¼‰
3. **å¦‚æœæ²¡æœ‰ initData**ï¼Œç­‰å¾… 1.5 ç§’åæ˜¾ç¤ºç™»å½•é€‰é¡¹

### 3. ç§»åŠ¨ç«¯æ’ç‰ˆéªŒè¯

1. **åœ¨ç§»åŠ¨è®¾å¤‡æˆ–æµè§ˆå™¨å¼€å‘è€…å·¥å…·ä¸­æ‰“å¼€**
2. **æ£€æŸ¥ç™»å½•ç•Œé¢**ï¼š
   - æŒ‰é’®åº”è¯¥æ˜¯å•åˆ—å¸ƒå±€ï¼ˆ< 480pxï¼‰
   - å†…å®¹ä¸åº”è¯¥æº¢å‡ºå±å¹•
   - æ‰€æœ‰å…ƒç´ åº”è¯¥å¯è§ä¸”å¯ç‚¹å‡»

## é¢„æœŸç»“æœ

### ç½‘é¡µç«¯
- âœ… Google ç™»å½•æˆåŠŸ
- âœ… å¯ä»¥è·å–ç”¨æˆ·ä¿¡æ¯
- âœ… å¯ä»¥æŸ¥çœ‹ä½™é¢
- âœ… æ‰€æœ‰åŠŸèƒ½æ­£å¸¸å·¥ä½œ

### Telegram MiniApp
- âœ… è‡ªåŠ¨ç™»å½•ï¼ˆå¦‚æœæœ‰ initDataï¼‰
- âœ… å¯ä»¥è·å–ç”¨æˆ·ä¿¡æ¯
- âœ… å¯ä»¥æŸ¥çœ‹ä½™é¢
- âœ… æ‰€æœ‰åŠŸèƒ½æ­£å¸¸å·¥ä½œ

### ç§»åŠ¨ç«¯
- âœ… ç™»å½•ç•Œé¢æ’ç‰ˆæ­£ç¡®
- âœ… æ‰€æœ‰æŒ‰é’®å¯è§ä¸”å¯ç‚¹å‡»
- âœ… å†…å®¹ä¸æº¢å‡ºå±å¹•

## æŠ€æœ¯ç»†èŠ‚

### JWT Token è®¤è¯æµç¨‹

1. ç”¨æˆ·é€šè¿‡ Google/Wallet ç™»å½•
2. åç«¯è¿”å› JWT Token
3. å‰ç«¯ä¿å­˜ Token åˆ° localStorage
4. åç»­è¯·æ±‚åœ¨ `Authorization: Bearer <token>` header ä¸­å‘é€
5. åç«¯éªŒè¯ Token å¹¶è¿”å›ç”¨æˆ·ä¿¡æ¯

### Telegram initData è®¤è¯æµç¨‹

1. Telegram WebApp æä¾› initData
2. å‰ç«¯åœ¨ `X-Telegram-Init-Data` header ä¸­å‘é€
3. åç«¯è§£æ initData è·å– tg_id
4. æ ¹æ® tg_id æŸ¥æ‰¾ç”¨æˆ·å¹¶è¿”å›ä¿¡æ¯

### åŒé‡è®¤è¯æ”¯æŒ

`/v1/users/me` ç«¯ç‚¹ç°åœ¨æ”¯æŒï¼š
1. **ä¼˜å…ˆ**: JWT Tokenï¼ˆWeb ç™»å½•ï¼‰
2. **å›é€€**: Telegram initDataï¼ˆTelegram MiniAppï¼‰

è¿™æ ·å¯ä»¥åŒæ—¶æ”¯æŒç½‘é¡µç«¯å’Œ Telegram MiniApp ç”¨æˆ·ã€‚

## å¸¸è§é—®é¢˜

### Q: Google ç™»å½•ä»ç„¶å¤±è´¥ï¼Ÿ
A: æ£€æŸ¥åç«¯æ—¥å¿—ï¼š
```bash
sudo journalctl -u luckyred-api -n 50 --no-pager | grep -i google
```

### Q: Telegram MiniApp æ— æ³•è®¤è¯ï¼Ÿ
A: æ£€æŸ¥ initData æ˜¯å¦æ­£ç¡®å‘é€ï¼š
- æ‰“å¼€æµè§ˆå™¨å¼€å‘è€…å·¥å…·
- æŸ¥çœ‹ Network æ ‡ç­¾
- æ£€æŸ¥è¯·æ±‚å¤´ä¸­æ˜¯å¦æœ‰ `X-Telegram-Init-Data`

### Q: ç§»åŠ¨ç«¯æ’ç‰ˆä»ç„¶é”™ä½ï¼Ÿ
A: æ¸…é™¤æµè§ˆå™¨ç¼“å­˜å¹¶å¼ºåˆ¶åˆ·æ–°ï¼ˆCtrl+Shift+Rï¼‰

## ä¸‹ä¸€æ­¥

1. **å®ç°çœŸå®çš„ Google OAuth**ï¼ˆç›®å‰æ˜¯ Mockï¼‰
2. **å®ç°çœŸå®çš„ Wallet ç­¾åéªŒè¯**ï¼ˆç›®å‰æ˜¯ Mockï¼‰
3. **å¯ç”¨ Telegram initData éªŒè¯**ï¼ˆç›®å‰æ˜¯å¯é€‰ï¼‰

