# 🔧 认证问题完整解决方案

## 当前问题

1. **Google 认证返回 401** - 后端可能缺少数据库表或 IdentityService 出错
2. **Telegram MiniApp 认证失败** - initData 为空或解析失败
3. **网页端功能未实现** - 已修复，但需要服务器更新

## 完整修复步骤

### 步骤 1: 在服务器上运行快速修复脚本

```bash
cd /opt/luckyred
git pull origin master
chmod +x scripts/sh/fix-auth-and-deploy.sh
./scripts/sh/fix-auth-and-deploy.sh
```

这个脚本会：
- 拉取最新代码
- 创建/更新数据库表（包括 `user_identities` 和 `account_links`）
- 重新构建前端
- 重启 API 服务
- 重新加载 Nginx

### 步骤 2: 如果快速修复失败，运行诊断脚本

```bash
chmod +x scripts/sh/diagnose-auth-issues.sh
./scripts/sh/diagnose-auth-issues.sh
```

这个脚本会检查：
- 数据库表是否存在
- API 服务状态
- 最近的错误日志
- API 端点响应
- Python 依赖
- 数据库连接

### 步骤 3: 手动检查和修复

#### 3.1 检查数据库表

```bash
cd /opt/luckyred/api
source .venv/bin/activate

python3 << 'EOF'
from shared.database.connection import init_db
init_db()
print("数据库表已创建/更新")
EOF
```

#### 3.2 检查 API 日志

```bash
# 查看最近的错误
sudo journalctl -u luckyred-api -n 100 --no-pager | grep -i "error\|exception\|google\|identity"

# 实时监控日志
sudo journalctl -u luckyred-api -f
```

#### 3.3 测试 Google 认证端点

```bash
curl -X POST http://localhost:8080/api/v1/auth/web/google \
  -H "Content-Type: application/json" \
  -d '{
    "id_token": "test_token",
    "email": "test@example.com",
    "given_name": "Test",
    "family_name": "User"
  }'
```

**预期结果**:
- 如果返回 200: ✅ 认证成功
- 如果返回 422: ✅ 端点正常（验证失败是预期的）
- 如果返回 500: ❌ 后端错误，需要查看日志

#### 3.4 检查数据库表结构

```bash
# PostgreSQL
psql -U your_user -d your_db -c "\d user_identities"
psql -U your_user -d your_db -c "\d account_links"

# SQLite
sqlite3 your_db.db ".schema user_identities"
sqlite3 your_db.db ".schema account_links"
```

## 常见问题和解决方案

### 问题 1: `user_identities` 表不存在

**症状**: Google 认证返回 500 错误，日志显示 "relation user_identities does not exist"

**解决**:
```bash
cd /opt/luckyred/api
source .venv/bin/activate
python3 -c "from shared.database.connection import init_db; init_db()"
```

### 问题 2: IdentityService 导入失败

**症状**: 日志显示 "ImportError: cannot import name 'IdentityService'"

**解决**:
```bash
cd /opt/luckyred/api
source .venv/bin/activate
pip install -r requirements.txt
```

### 问题 3: 数据库连接失败

**症状**: 日志显示数据库连接错误

**解决**:
1. 检查 `.env` 文件中的 `DATABASE_URL`
2. 确保数据库服务运行中
3. 检查数据库用户权限

### 问题 4: Telegram initData 为空

**症状**: 在浏览器中访问时，initData 为空（这是正常的）

**说明**: 
- 在浏览器中访问时，initData 为空是正常的
- 应该显示登录选项（Google、Telegram、Facebook 等）
- 只有在 Telegram 客户端中打开时才会有 initData

## 验证清单

- [ ] 数据库表已创建（`users`, `user_identities`, `account_links`）
- [ ] API 服务运行正常
- [ ] 前端已重新构建
- [ ] Nginx 已重新加载
- [ ] Google 认证端点响应正常（不是 500）
- [ ] 浏览器缓存已清除
- [ ] 可以成功登录（Google 或其他方式）

## 测试步骤

### 1. 测试 Google 登录

1. 清除浏览器缓存
2. 访问 https://mini.usdt2026.cc
3. 点击 "使用Google登录"
4. 应该成功登录（即使使用 Mock 数据）

### 2. 测试 Telegram MiniApp

1. 在 Telegram 中打开 MiniApp
2. 如果有 initData，应该自动登录
3. 如果没有 initData，等待 1.5 秒后显示登录选项

### 3. 测试其他登录方式

- Wallet 连接
- Magic Link
- Facebook（占位）
- WhatsApp（占位）

## 如果问题仍然存在

1. **查看详细日志**:
   ```bash
   sudo journalctl -u luckyred-api -n 200 --no-pager | grep -A 10 -i "error\|exception"
   ```

2. **检查数据库**:
   ```bash
   # 查看表是否存在
   python3 -c "
   from shared.database.connection import sync_engine
   from sqlalchemy import inspect
   inspector = inspect(sync_engine)
   print('Tables:', inspector.get_table_names())
   "
   ```

3. **测试 IdentityService**:
   ```bash
   python3 -c "
   import asyncio
   from api.services.identity_service import IdentityService
   from shared.database.connection import get_async_db
   
   async def test():
       async for db in get_async_db():
           try:
               user = await IdentityService.get_or_create_user_by_identity(
                   db=db,
                   provider='google',
                   provider_user_id='test@example.com',
                   provider_data={'email': 'test@example.com'}
               )
               print(f'✅ 成功创建用户: {user.id}')
           except Exception as e:
               print(f'❌ 错误: {e}')
               import traceback
               traceback.print_exc()
   
   asyncio.run(test())
   "
   ```

## 预期结果

修复后应该：
- ✅ Google 登录成功（使用 Mock 数据）
- ✅ 可以获取用户信息
- ✅ 可以查看余额
- ✅ 所有功能正常工作
- ✅ Telegram MiniApp 可以自动登录（如果有 initData）
- ✅ 网页端可以正常使用所有功能

