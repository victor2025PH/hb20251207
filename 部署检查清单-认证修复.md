# éƒ¨ç½²æ£€æŸ¥æ¸…å• - è®¤è¯ä¿®å¤

## âœ… å·²å®Œæˆçš„ä¿®å¤

### 1. ä¿®å¤æœªç™»å½•æ—¶è°ƒç”¨éœ€è¦è®¤è¯çš„ API
- **æ–‡ä»¶**: `frontend/src/components/TopToolbar.tsx`
- **ä¿®å¤**: æ·»åŠ  `enabled: isAuthenticated` é€‰é¡¹ï¼Œåªåœ¨å·²è®¤è¯æ—¶æ‰§è¡ŒæŸ¥è¯¢
- **æ•ˆæœ**: ä¸å†å‡ºç° 401 é”™è¯¯

### 2. ä¿®å¤æœªç™»å½•æ—¶åˆå§‹åŒ– WebSocket
- **æ–‡ä»¶**: `frontend/src/App.tsx`
- **ä¿®å¤**: åªåœ¨ `isAuthenticated` ä¸º `true` æ—¶åˆå§‹åŒ–é€šçŸ¥ç®¡ç†å™¨
- **æ•ˆæœ**: ä¸å†å‡ºç° WebSocket è¿æ¥å¤±è´¥é”™è¯¯

### 3. ä¼˜åŒ– AuthGuard ç”¨æˆ·ä½“éªŒ
- **æ–‡ä»¶**: `frontend/src/utils/auth/AuthGuard.tsx`
- **ä¿®å¤**: 
  - `initData` ä¸ºç©ºæ—¶ç›´æ¥æ˜¾ç¤ºç™»å½•é€‰é¡¹ï¼Œä¸æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
  - æœ‰ `initData` ä½†è®¤è¯å¤±è´¥æ—¶ï¼Œæ˜¾ç¤º"æ­£åœ¨éªŒè¯..."è€Œä¸æ˜¯"Telegramè®¤è¯å¤±è´¥"
- **æ•ˆæœ**: ç”¨æˆ·ä½“éªŒæ›´æµç•…ï¼Œä¸å†æ˜¾ç¤ºè¯¯å¯¼æ€§çš„é”™è¯¯ä¿¡æ¯

## ğŸ“‹ éƒ¨ç½²æ­¥éª¤

### 1. åœ¨æœåŠ¡å™¨ä¸Šæ‹‰å–æœ€æ–°ä»£ç 

```bash
cd /opt/luckyred
git pull origin master
```

### 2. é‡æ–°æ„å»ºå‰ç«¯

```bash
cd frontend
npm install  # å¦‚æœéœ€è¦æ›´æ–°ä¾èµ–
npm run build
```

### 3. é‡å¯æœåŠ¡

```bash
# é‡å¯ Nginxï¼ˆå¦‚æœéœ€è¦ï¼‰
sudo systemctl restart nginx

# æ£€æŸ¥ API æœåŠ¡çŠ¶æ€ï¼ˆå¦‚æœéœ€è¦é‡å¯ï¼‰
sudo systemctl status luckyred-api
```

### 4. æ¸…é™¤æµè§ˆå™¨ç¼“å­˜

åœ¨æµè§ˆå™¨ä¸­ï¼š
1. æŒ‰ `Ctrl+Shift+Delete` (Windows) æˆ– `Cmd+Shift+Delete` (Mac)
2. é€‰æ‹©"ç¼“å­˜çš„å›¾ç‰‡å’Œæ–‡ä»¶"
3. ç‚¹å‡»"æ¸…é™¤æ•°æ®"
4. æˆ–è€…ä½¿ç”¨ç¡¬åˆ·æ–°ï¼š`Ctrl+Shift+R` (Windows) æˆ– `Cmd+Shift+R` (Mac)

## âœ… éªŒè¯æ­¥éª¤

### 1. æ£€æŸ¥æ§åˆ¶å°
è®¿é—® `https://mini.usdt2026.cc`ï¼Œæ‰“å¼€å¼€å‘è€…å·¥å…·æ§åˆ¶å°ï¼Œåº”è¯¥çœ‹åˆ°ï¼š
- âœ… `[Telegram] initData is empty` è­¦å‘Šï¼ˆè¿™æ˜¯æ­£å¸¸çš„ï¼‰
- âœ… **æ²¡æœ‰** `401 Unauthorized` é”™è¯¯
- âœ… **æ²¡æœ‰** `[WebSocket] No valid authentication` é”™è¯¯

### 2. æ£€æŸ¥ç™»å½•ç•Œé¢
- âœ… ç›´æ¥æ˜¾ç¤ºç™»å½•é€‰é¡¹ï¼ˆGoogleã€Telegramã€Facebook ç­‰ï¼‰
- âœ… **ä¸æ˜¾ç¤º** "Telegramè®¤è¯å¤±è´¥" é”™è¯¯ä¿¡æ¯
- âœ… ç•Œé¢æµç•…ï¼Œæ²¡æœ‰é—ªçƒæˆ–å»¶è¿Ÿ

### 3. æµ‹è¯•ç™»å½•åŠŸèƒ½
1. ç‚¹å‡»"ä½¿ç”¨Googleç™»å½•"
2. å®Œæˆ Google ç™»å½•æµç¨‹
3. åº”è¯¥æˆåŠŸç™»å½•å¹¶è·³è½¬åˆ°ä¸»é¡µé¢
4. æ§åˆ¶å°åº”è¯¥æ˜¾ç¤º `[WebSocket] Using JWT token for authentication.`
5. WebSocket åº”è¯¥æˆåŠŸè¿æ¥

## ğŸ” å¦‚æœä»ç„¶çœ‹åˆ°é—®é¢˜

### é—®é¢˜ 1: ä»ç„¶æ˜¾ç¤º "Telegramè®¤è¯å¤±è´¥"
**åŸå› **: æµè§ˆå™¨ç¼“å­˜äº†æ—§çš„å‰ç«¯ä»£ç 

**è§£å†³æ–¹æ¡ˆ**:
1. æ¸…é™¤æµè§ˆå™¨ç¼“å­˜ï¼ˆè§ä¸Šé¢çš„æ­¥éª¤ï¼‰
2. ä½¿ç”¨ç¡¬åˆ·æ–°ï¼š`Ctrl+Shift+R` æˆ– `Cmd+Shift+R`
3. æˆ–è€…ä½¿ç”¨æ— ç—•æ¨¡å¼æµ‹è¯•

### é—®é¢˜ 2: ä»ç„¶çœ‹åˆ° 401 é”™è¯¯
**åŸå› **: å‰ç«¯ä»£ç å¯èƒ½æ²¡æœ‰æ­£ç¡®æ„å»ºæˆ–éƒ¨ç½²

**è§£å†³æ–¹æ¡ˆ**:
```bash
# æ£€æŸ¥å‰ç«¯æ„å»ºæ˜¯å¦æˆåŠŸ
cd /opt/luckyred/frontend
npm run build

# æ£€æŸ¥æ„å»ºè¾“å‡º
ls -la dist/

# æ£€æŸ¥ Nginx é…ç½®æ˜¯å¦æ­£ç¡®æŒ‡å‘ dist ç›®å½•
sudo nginx -t
```

### é—®é¢˜ 3: WebSocket è¿æ¥å¤±è´¥
**åŸå› **: Nginx é…ç½®å¯èƒ½æœ‰é—®é¢˜

**è§£å†³æ–¹æ¡ˆ**:
```bash
# æ£€æŸ¥ Nginx é…ç½®
sudo nginx -t

# æŸ¥çœ‹ Nginx é”™è¯¯æ—¥å¿—
sudo tail -f /var/log/nginx/error.log

# æ£€æŸ¥ WebSocket ä»£ç†é…ç½®
cat deploy/nginx/mini.usdt2026.cc-ssl.conf | grep -A 20 "messages/ws"
```

## ğŸ“ ç›¸å…³æ–‡ä»¶

- `frontend/src/components/TopToolbar.tsx` - é¡¶éƒ¨å·¥å…·æ ç»„ä»¶
- `frontend/src/App.tsx` - ä¸»åº”ç”¨ç»„ä»¶
- `frontend/src/utils/auth/AuthGuard.tsx` - è®¤è¯å®ˆå«ç»„ä»¶
- `frontend/src/utils/auth/useAuth.ts` - è®¤è¯ Hook
- `frontend/src/utils/api.ts` - API å®¢æˆ·ç«¯

## ğŸ¯ é¢„æœŸç»“æœ

ä¿®å¤åï¼Œç”¨æˆ·åœ¨æ™®é€šæµè§ˆå™¨ä¸­è®¿é—® `mini.usdt2026.cc` æ—¶ï¼š
1. âœ… ç›´æ¥çœ‹åˆ°ç™»å½•é€‰é¡¹ï¼Œæ²¡æœ‰é”™è¯¯ä¿¡æ¯
2. âœ… æ§åˆ¶å°æ²¡æœ‰ 401 é”™è¯¯
3. âœ… WebSocket ä¸ä¼šå°è¯•è¿æ¥ï¼ˆç›´åˆ°ç”¨æˆ·ç™»å½•ï¼‰
4. âœ… ç™»å½•åä¸€åˆ‡æ­£å¸¸å·¥ä½œ

